# X おすすめフィード アルゴリズム

このリポジトリは、Xの「おすすめ」フィードを動かすコアレコメンドシステムを含んでいます。フォロー中アカウントからのイン・ネットワークコンテンツと、ML ベースの検索で発見したアウト・オブ・ネットワークコンテンツを組み合わせ、Grok ベースの Transformer モデルですべてをランキングします。

> **注記**: Transformer の実装は、xAI による [Grok-1 オープンソースリリース](https://github.com/xai-org/grok-1) から移植し、レコメンドシステム用に適応しています。

## 目次

- [概要](#概要)
- [システムアーキテクチャ](#システムアーキテクチャ)
- [コンポーネント](#コンポーネント)
  - [Home Mixer](#home-mixer)
  - [Thunder](#thunder)
  - [Phoenix](#phoenix)
  - [Candidate Pipeline](#candidate-pipeline)
- [仕組み](#仕組み)
  - [パイプラインステージ](#パイプラインステージ)
  - [スコアリングとランキング](#スコアリングとランキング)
  - [フィルタリング](#フィルタリング)
- [主な設計判断](#主な設計判断)
- [ライセンス](#ライセンス)

---

## 概要

おすすめフィードのアルゴリズムは、2つのソースから投稿を取得・ランキング・フィルタリングします：

1. **イン・ネットワーク (Thunder)**: フォロー中アカウントからの投稿
2. **アウト・オブ・ネットワーク (Phoenix Retrieval)**: グローバルコーパスから発見した投稿

両方のソースは **Phoenix**（Grok ベースの Transformer モデル）で統合・ランキングされます。Phoenix は各投稿のエンゲージメント確率を予測し、最終スコアはこれらの予測エンゲージメントの重み付け合計となります。

システムから手作業による特徴エンジニアリングとほとんどのヒューリスティックを排除しました。Grok ベースの Transformer が、あなたのエンゲージメント履歴（いいね、リプライ、シェアなど）を理解し、どのコンテンツが関連性があるかを判断するすべての重要な処理を行います。

---

## システムアーキテクチャ

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    おすすめフィード リクエスト                                  │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
                                               │
                                               ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                                         HOME MIXER                                          │
│                                      (オーケストレーション層)                                   │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                   クエリ ハイドレーション                              │   │
│   │  ┌──────────────────────────┐    ┌──────────────────────────────────────────────┐   │   │
│   │  │ ユーザーアクション履歴     │    │ ユーザー特徴量                                │   │   │
│   │  │ (エンゲージメント履歴)     │    │ (フォローリスト、設定など)                     │   │   │
│   │  └──────────────────────────┘    └──────────────────────────────────────────────┘   │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              │                                              │
│                                              ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                   候補ソース                                         │   │
│   │         ┌─────────────────────────────┐    ┌────────────────────────────────┐       │   │
│   │         │        THUNDER              │    │     PHOENIX RETRIEVAL          │       │   │
│   │         │    (イン・ネットワーク)       │    │   (アウト・オブ・ネットワーク)    │       │   │
│   │         │                             │    │                                │       │   │
│   │         │  フォロー中アカウント         │    │  グローバルコーパスからの        │       │   │
│   │         │  からの投稿                  │    │  ML ベース類似度検索            │       │   │
│   │         └─────────────────────────────┘    └────────────────────────────────┘       │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              │                                              │
│                                              ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                    ハイドレーション                                   │   │
│   │  追加データの取得: 投稿メタデータ、投稿者情報、メディアエンティティなど                    │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              │                                              │
│                                              ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                    フィルタリング                                     │   │
│   │  除外: 重複、古い投稿、自分の投稿、ブロック済み投稿者、ミュート済みキーワードなど          │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              │                                              │
│                                              ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                     スコアリング                                     │   │
│   │  ┌──────────────────────────┐                                                       │   │
│   │  │  Phoenix Scorer          │    Grok ベース Transformer が予測:                     │   │
│   │  │  (ML 予測)               │    P(いいね), P(リプライ), P(リポスト), P(クリック)...    │   │
│   │  └──────────────────────────┘                                                       │   │
│   │               │                                                                     │   │
│   │               ▼                                                                     │   │
│   │  ┌──────────────────────────┐                                                       │   │
│   │  │  Weighted Scorer         │    重み付きスコア = Σ (重み × P(アクション))            │   │
│   │  │  (予測を統合)            │                                                       │   │
│   │  └──────────────────────────┘                                                       │   │
│   │               │                                                                     │   │
│   │               ▼                                                                     │   │
│   │  ┌──────────────────────────┐                                                       │   │
│   │  │  Author Diversity        │    同一投稿者の繰り返しスコアを減衰                      │   │
│   │  │  Scorer                  │    フィードの多様性を確保                              │   │
│   │  └──────────────────────────┘                                                       │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              │                                              │
│                                              ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                      選択                                           │   │
│   │                    最終スコアでソートし、上位 K 件の候補を選択                          │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              │                                              │
│                                              ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                            フィルタリング (選択後)                                    │   │
│   │               可視性フィルタリング (削除済み/スパム/暴力/グロなど)                       │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
                                               │
                                               ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                                   ランキング済みフィード レスポンス                            │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## コンポーネント

### Home Mixer

**場所:** [`home-mixer/`](home-mixer/)

おすすめフィードを組み立てるオーケストレーション層。`CandidatePipeline` フレームワークを活用し、以下のステージで構成：

| ステージ | 説明 |
|---------|------|
| Query Hydrators | ユーザーコンテキスト（エンゲージメント履歴、フォローリスト）を取得 |
| Sources | Thunder と Phoenix から候補を取得 |
| Hydrators | 候補に追加データを付与 |
| Filters | 不適格な候補を除外 |
| Scorers | エンゲージメントを予測し最終スコアを計算 |
| Selector | スコアでソートし上位 K 件を選択 |
| Post-Selection Filters | 最終的な可視性と重複チェック |
| Side Effects | 将来の使用のためリクエスト情報をキャッシュ |

サーバーは gRPC エンドポイント（`ScoredPostsService`）を公開し、指定ユーザーのランキング済み投稿を返します。

---

### Thunder

**場所:** [`thunder/`](thunder/)

全ユーザーの最近の投稿を追跡するインメモリ投稿ストアとリアルタイム取り込みパイプライン：

- Kafka から投稿作成/削除イベントを消費
- ユーザーごとにオリジナル投稿、リプライ/リポスト、動画投稿のストアを維持
- リクエストユーザーがフォローしているアカウントから「イン・ネットワーク」投稿候補を提供
- 保持期間を過ぎた投稿を自動的にトリム

Thunder により、外部データベースへのアクセスなしでイン・ネットワークコンテンツをサブミリ秒で検索できます。

---

### Phoenix

**場所:** [`phoenix/`](phoenix/)

2つの主要機能を持つ ML コンポーネント：

#### 1. 検索 (Two-Tower モデル)
関連するアウト・オブ・ネットワーク投稿を発見：
- **User Tower**: ユーザー特徴量とエンゲージメント履歴を埋め込みにエンコード
- **Candidate Tower**: すべての投稿を埋め込みにエンコード
- **類似度検索**: 内積類似度で上位 K 件の投稿を取得

#### 2. ランキング (候補分離付き Transformer)
各候補のエンゲージメント確率を予測：
- ユーザーコンテキスト（エンゲージメント履歴）と候補投稿を入力
- 候補が互いにアテンションできないよう特別なアテンションマスクを使用
- 各アクションタイプ（いいね、リプライ、リポスト、クリックなど）の確率を出力

詳細なアーキテクチャドキュメントは [`phoenix/README.md`](phoenix/README.md) を参照。

---

### Candidate Pipeline

**場所:** [`candidate-pipeline/`](candidate-pipeline/)

レコメンドパイプライン構築用の再利用可能フレームワーク。以下のトレイトを定義：

| トレイト | 目的 |
|---------|------|
| `Source` | データソースから候補を取得 |
| `Hydrator` | 候補に追加特徴量を付与 |
| `Filter` | 表示すべきでない候補を除外 |
| `Scorer` | ランキング用スコアを計算 |
| `Selector` | ソートして上位候補を選択 |
| `SideEffect` | 非同期副作用を実行（キャッシュ、ログ） |

フレームワークは可能な限りソースとハイドレーターを並列実行し、設定可能なエラーハンドリングとログ機能を備えています。

---

## 仕組み

### パイプラインステージ

1. **クエリ ハイドレーション**: ユーザーの最近のエンゲージメント履歴とメタデータ（フォローリストなど）を取得

2. **候補ソーシング**: 以下から候補を取得：
   - **Thunder**: フォロー中アカウントの最近の投稿（イン・ネットワーク）
   - **Phoenix Retrieval**: グローバルコーパスから ML で発見した投稿（アウト・オブ・ネットワーク）

3. **候補ハイドレーション**: 候補に以下を付与：
   - コア投稿データ（テキスト、メディアなど）
   - 投稿者情報（ユーザー名、認証ステータス）
   - 動画の長さ（動画投稿の場合）
   - サブスクリプションステータス

4. **スコアリング前フィルター**: 以下の投稿を除外：
   - 重複
   - 古すぎる投稿
   - 閲覧者自身の投稿
   - ブロック/ミュート済みアカウントからの投稿
   - ミュート済みキーワードを含む投稿
   - 既に見た投稿または最近提供した投稿
   - アクセス不可のサブスクリプションコンテンツ

5. **スコアリング**: 複数のスコアラーを順次適用：
   - **Phoenix Scorer**: Phoenix Transformer モデルから ML 予測を取得
   - **Weighted Scorer**: 予測を最終関連性スコアに統合
   - **Author Diversity Scorer**: 多様性のため同一投稿者の繰り返しスコアを減衰
   - **OON Scorer**: アウト・オブ・ネットワークコンテンツのスコアを調整

6. **選択**: スコアでソートし上位 K 件の候補を選択

7. **選択後処理**: 提供する投稿候補の最終検証

---

### スコアリングとランキング

Phoenix の Grok ベース Transformer モデルは、複数のエンゲージメントタイプの確率を予測します：

```
予測:
├── P(いいね)
├── P(リプライ)
├── P(リポスト)
├── P(引用)
├── P(クリック)
├── P(プロフィールクリック)
├── P(動画視聴)
├── P(画像展開)
├── P(シェア)
├── P(滞在時間)
├── P(投稿者フォロー)
├── P(興味なし)
├── P(投稿者ブロック)
├── P(投稿者ミュート)
└── P(報告)
```

**Weighted Scorer** はこれらを最終スコアに統合します：

```
最終スコア = Σ (重み_i × P(アクション_i))
```

ポジティブなアクション（いいね、リポスト、シェア）はプラスの重み。ネガティブなアクション（ブロック、ミュート、報告）はマイナスの重みを持ち、ユーザーが嫌いそうなコンテンツを押し下げます。

---

### フィルタリング

フィルターは2つのステージで実行されます：

**スコアリング前フィルター:**
| フィルター | 目的 |
|-----------|------|
| `DropDuplicatesFilter` | 重複投稿 ID を除外 |
| `CoreDataHydrationFilter` | コアメタデータのハイドレーションに失敗した投稿を除外 |
| `AgeFilter` | 閾値より古い投稿を除外 |
| `SelfpostFilter` | ユーザー自身の投稿を除外 |
| `RepostDeduplicationFilter` | 同じコンテンツのリポストを重複排除 |
| `IneligibleSubscriptionFilter` | ユーザーがアクセスできないペイウォールコンテンツを除外 |
| `PreviouslySeenPostsFilter` | ユーザーが既に見た投稿を除外 |
| `PreviouslyServedPostsFilter` | セッション中に既に提供した投稿を除外 |
| `MutedKeywordFilter` | ユーザーのミュート済みキーワードを含む投稿を除外 |
| `AuthorSocialgraphFilter` | ブロック/ミュート済み投稿者からの投稿を除外 |

**選択後フィルター:**
| フィルター | 目的 |
|-----------|------|
| `VFFilter` | 削除済み/スパム/暴力/グロなどの投稿を除外 |
| `DedupConversationFilter` | 同じ会話スレッドの複数ブランチを重複排除 |

---

## 主な設計判断

### 1. 手作業による特徴エンジニアリングなし
システムは完全に Grok ベースの Transformer に依存し、ユーザーエンゲージメントシーケンスから関連性を学習します。コンテンツ関連性のための手動特徴エンジニアリングはありません。これにより、データパイプラインと配信インフラの複雑さが大幅に削減されます。

### 2. ランキングにおける候補分離
Transformer 推論中、候補は互いにアテンションできません—ユーザーコンテキストのみにアテンションします。これにより、投稿のスコアがバッチ内の他の投稿に依存せず、スコアが一貫してキャッシュ可能になります。

### 3. ハッシュベースの埋め込み
検索とランキングの両方で、埋め込みルックアップに複数のハッシュ関数を使用

### 4. マルチアクション予測
単一の「関連性」スコアを予測するのではなく、モデルは多くのアクションの確率を予測します。

### 5. 構成可能なパイプラインアーキテクチャ
`candidate-pipeline` クレートは、柔軟なレコメンドパイプライン構築フレームワークを提供：
- パイプライン実行・監視とビジネスロジックの分離
- 独立ステージの並列実行と優雅なエラーハンドリング
- 新しいソース、ハイドレーション、フィルター、スコアラーの容易な追加

---

## ライセンス

このプロジェクトは Apache License 2.0 でライセンスされています。詳細は [LICENSE](LICENSE) を参照してください。
