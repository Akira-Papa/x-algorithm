# X Algorithm 仕様書: システム概要

**バージョン:** 1.0
**最終更新日:** 2026年1月
**ステータス:** 公開

---

## 目次

1. [プロジェクト概要](#1-プロジェクト概要)
2. [For Youフィードとは](#2-for-youフィードとは)
3. [主要コンポーネント一覧](#3-主要コンポーネント一覧)
4. [技術スタック](#4-技術スタック)
5. [システム全体の目的と設計思想](#5-システム全体の目的と設計思想)
6. [データフロー概要](#6-データフロー概要)

---

## 1. プロジェクト概要

### 1.1 概要

本リポジトリは、Xの「For You」フィードを支えるコアレコメンデーションシステムの実装を含みます。このシステムは、ユーザーがフォローしているアカウントからのコンテンツ（イン・ネットワーク）と、機械学習ベースの検索で発見されたコンテンツ（アウト・オブ・ネットワーク）を組み合わせ、Grokベースのトランスフォーマーモデルを使用してランキングします。

### 1.2 主な特徴

- **手動特徴量エンジニアリングの排除**: システムはGrokベースのトランスフォーマーに完全に依存し、ユーザーのエンゲージメント履歴から関連性を学習します
- **候補分離（Candidate Isolation）**: ランキング時に候補同士が互いに参照できないよう特殊なアテンションマスクを使用
- **マルチアクション予測**: 単一の「関連性」スコアではなく、複数のエンゲージメントタイプの確率を予測
- **構成可能なパイプラインアーキテクチャ**: 柔軟で拡張可能なレコメンデーションパイプラインフレームワーク

### 1.3 トランスフォーマー実装について

本システムのトランスフォーマー実装は、xAIによる[Grok-1オープンソースリリース](https://github.com/xai-org/grok-1)からポートされ、レコメンデーションシステムのユースケースに適応されています。

---

## 2. For Youフィードとは

### 2.1 概念

For Youフィードは、Xにおけるパーソナライズされたタイムラインであり、各ユーザーに最も関連性の高いコンテンツを表示することを目的としています。従来の時系列ベースのタイムラインとは異なり、機械学習モデルがユーザーの興味・関心に基づいてコンテンツを選択・順序付けします。

### 2.2 コンテンツソース

For Youフィードは、2つの主要なソースからコンテンツを取得します:

| ソース | 説明 | コンポーネント |
|--------|------|----------------|
| **イン・ネットワーク** | ユーザーがフォローしているアカウントからの投稿 | Thunder |
| **アウト・オブ・ネットワーク** | グローバルコーパスからML検索で発見された投稿 | Phoenix Retrieval |

### 2.3 処理フロー概要

```
ユーザーリクエスト
      │
      ▼
┌─────────────────────┐
│   候補取得          │  ← Thunder（イン・ネットワーク）
│   (Sourcing)        │  ← Phoenix（アウト・オブ・ネットワーク）
└─────────────────────┘
      │
      ▼
┌─────────────────────┐
│   データ補完        │  ← 投稿メタデータ、著者情報等を付加
│   (Hydration)       │
└─────────────────────┘
      │
      ▼
┌─────────────────────┐
│   フィルタリング    │  ← 重複排除、ブロック/ミュート適用
│   (Filtering)       │
└─────────────────────┘
      │
      ▼
┌─────────────────────┐
│   スコアリング      │  ← Phoenix ML予測 → 重み付けスコア
│   (Scoring)         │
└─────────────────────┘
      │
      ▼
┌─────────────────────┐
│   選択              │  ← 上位K件を選択
│   (Selection)       │
└─────────────────────┘
      │
      ▼
 ランク付けされたフィード
```

---

## 3. 主要コンポーネント一覧

### 3.1 コンポーネント概要図

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           X FOR YOU ALGORITHM                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────────┐  │
│  │   HOME MIXER    │◄───│    THUNDER      │    │        PHOENIX          │  │
│  │  (オーケスト    │    │ (イン・ネット   │    │ ┌─────────┐ ┌─────────┐ │  │
│  │   レーション)   │◄───│   ワーク)       │    │ │Retrieval│ │ Ranking │ │  │
│  │                 │    │                 │    │ │(検索)   │ │(ランク) │ │  │
│  │                 │◄───┼─────────────────┼────│ └─────────┘ └─────────┘ │  │
│  └─────────────────┘    └─────────────────┘    └─────────────────────────┘  │
│          │                                                                  │
│          │ 利用                                                             │
│          ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     CANDIDATE PIPELINE (フレームワーク)              │    │
│  │  Source │ Hydrator │ Filter │ Scorer │ Selector │ SideEffect        │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Home Mixer

**ディレクトリ:** `home-mixer/`

Home Mixerは、For Youフィードを組み立てるオーケストレーションレイヤーです。Candidate Pipelineフレームワークを活用し、以下のステージを実行します:

| ステージ | 説明 | 主要コンポーネント |
|----------|------|-------------------|
| **Query Hydrators** | ユーザーコンテキストの取得 | `UserActionSeqQueryHydrator`, `UserFeaturesQueryHydrator` |
| **Sources** | 候補の取得 | `ThunderSource`, `PhoenixSource` |
| **Hydrators** | 候補データの補完 | `CoreDataCandidateHydrator`, `GizmoduckHydrator`, etc. |
| **Filters** | 不適格な候補の除去 | `AgeFilter`, `MutedKeywordFilter`, `AuthorSocialgraphFilter`, etc. |
| **Scorers** | スコア計算 | `PhoenixScorer`, `WeightedScorer`, `AuthorDiversityScorer`, `OONScorer` |
| **Selector** | 上位候補の選択 | `TopKScoreSelector` |
| **Post-Selection Filters** | 最終検証 | `VFFilter`, `DedupConversationFilter` |
| **Side Effects** | 非同期処理 | `CacheRequestInfoSideEffect` |

**サービスエンドポイント:**
- gRPC: `ScoredPostsService`
- プロトコル: gzip/zstd圧縮対応

### 3.3 Thunder

**ディレクトリ:** `thunder/`

Thunderは、イン・ネットワークコンテンツを提供するリアルタイム投稿ストアです。

#### 主な機能

| 機能 | 説明 |
|------|------|
| **リアルタイム取り込み** | Kafkaから投稿作成/削除イベントを消費 |
| **インメモリストレージ** | ユーザーごとの投稿をメモリ内で管理 |
| **自動トリミング** | 保持期間を超えた投稿を自動削除 |
| **高速ルックアップ** | サブミリ秒のイン・ネットワークコンテンツ検索 |

#### 投稿カテゴリ

- オリジナル投稿
- リプライ/リポスト
- 動画投稿

#### サービスエンドポイント

```rust
// gRPC Service: InNetworkPostsService
async fn get_in_network_posts(
    request: GetInNetworkPostsRequest,
) -> Result<GetInNetworkPostsResponse, Status>
```

### 3.4 Phoenix

**ディレクトリ:** `phoenix/`

Phoenixは、機械学習ベースの検索とランキングを担当するコンポーネントです。2つの主要機能を持ちます。

#### 3.4.1 Retrieval（Two-Tower Model）

アウト・オブ・ネットワーク投稿を効率的に検索します。

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        TWO-TOWER RETRIEVAL                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌─────────────────┐              ┌─────────────────┐                  │
│   │   USER TOWER    │              │ CANDIDATE TOWER │                  │
│   │                 │              │                 │                  │
│   │ ユーザー特徴量  │              │  投稿+著者      │                  │
│   │ + 履歴          │              │  エンベディング │                  │
│   │       │         │              │       │         │                  │
│   │       ▼         │              │       ▼         │                  │
│   │  Transformer    │              │     MLP         │                  │
│   │       │         │              │       │         │                  │
│   │       ▼         │              │       ▼         │                  │
│   │  User Embedding │              │ Item Embedding  │                  │
│   │     [B, D]      │              │    [N, D]       │                  │
│   └────────┬────────┘              └────────┬────────┘                  │
│            │                                │                           │
│            └────────────┬───────────────────┘                           │
│                         │                                               │
│                         ▼                                               │
│              ┌─────────────────────┐                                    │
│              │   Dot Product       │                                    │
│              │   Similarity        │                                    │
│              │   + Top-K Selection │                                    │
│              └─────────────────────┘                                    │
│                         │                                               │
│                         ▼                                               │
│                   Top-K Candidates                                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**特徴:**
- ユーザータワー: ユーザー特徴量とエンゲージメント履歴をエンコード
- 候補タワー: 全投稿をエンベディングに変換
- 類似度検索: ドット積による近似最近傍探索（ANN）

#### 3.4.2 Ranking（Transformer with Candidate Isolation）

候補のエンゲージメント確率を予測します。

**アテンションマスク構造:**

```
                    キー (参照先)
         ────────────────────────────────────────────────▶

         │ User │      History (S)       │   Candidates (C)    │
    ┌────┼──────┼────────────────────────┼─────────────────────┤
    │    │      │                        │                     │
    │ U  │  ✓   │  ✓   ✓   ✓   ✓   ✓   ✓ │  ✗   ✗   ✗   ✗   ✗  │
    │    │      │                        │                     │
    ├────┼──────┼────────────────────────┼─────────────────────┤
 Q  │    │      │                        │                     │
 u  │ H  │  ✓   │  ✓   ✓   ✓   ✓   ✓   ✓ │  ✗   ✗   ✗   ✗   ✗  │
 e  │ i  │  ✓   │  ✓   ✓   ✓   ✓   ✓   ✓ │  ✗   ✗   ✗   ✗   ✗  │
 r  │ s  │  ✓   │  ✓   ✓   ✓   ✓   ✓   ✓ │  ✗   ✗   ✗   ✗   ✗  │
 y  │ t  │  ✓   │  ✓   ✓   ✓   ✓   ✓   ✓ │  ✗   ✗   ✗   ✗   ✗  │
    │    │      │                        │                     │
    ├────┼──────┼────────────────────────┼─────────────────────┤
 │  │    │      │                        │ 対角線のみ(自己参照) │
 │  │ C  │  ✓   │  ✓   ✓   ✓   ✓   ✓   ✓ │  ✓   ✗   ✗   ✗   ✗  │
 │  │ a  │  ✓   │  ✓   ✓   ✓   ✓   ✓   ✓ │  ✗   ✓   ✗   ✗   ✗  │
 │  │ n  │  ✓   │  ✓   ✓   ✓   ✓   ✓   ✓ │  ✗   ✗   ✓   ✗   ✗  │
 │  │ d  │  ✓   │  ✓   ✓   ✓   ✓   ✓   ✓ │  ✗   ✗   ✗   ✓   ✗  │
 ▼  │ s  │  ✓   │  ✓   ✓   ✓   ✓   ✓   ✓ │  ✗   ✗   ✗   ✗   ✓  │
    │    │      │                        │                     │
    └────┴──────┴────────────────────────┴─────────────────────┘

    ✓ = 参照可能          ✗ = 参照不可
```

**予測されるアクション:**

| カテゴリ | アクション |
|----------|-----------|
| **ポジティブ** | favorite, reply, repost, quote, click, profile_click, video_view, photo_expand, share, dwell, follow_author |
| **ネガティブ** | not_interested, block_author, mute_author, report |

### 3.5 Candidate Pipeline

**ディレクトリ:** `candidate-pipeline/`

再利用可能なレコメンデーションパイプラインフレームワークです。

#### トレイト定義

| トレイト | 目的 | メソッド |
|----------|------|----------|
| `Source` | データソースから候補を取得 | `get_candidates()` |
| `Hydrator` | 候補に追加情報を付与 | `hydrate()`, `update()` |
| `Filter` | 不適格な候補を除去 | `filter()` |
| `Scorer` | ランキング用スコアを計算 | `score()`, `update()` |
| `Selector` | 候補をソート・選択 | `select()` |
| `SideEffect` | 非同期副作用を実行 | `run()` |
| `QueryHydrator` | クエリにユーザーコンテキストを付与 | `hydrate()`, `update()` |

#### パイプライン実行フロー

```rust
async fn execute(&self, query: Q) -> PipelineResult<Q, C> {
    // 1. クエリハイドレーション（並列）
    let hydrated_query = self.hydrate_query(query).await;

    // 2. 候補取得（並列）
    let candidates = self.fetch_candidates(&hydrated_query).await;

    // 3. 候補ハイドレーション（並列）
    let hydrated_candidates = self.hydrate(&hydrated_query, candidates).await;

    // 4. プリスコアリングフィルタ（順次）
    let (kept, filtered) = self.filter(&hydrated_query, hydrated_candidates).await;

    // 5. スコアリング（順次）
    let scored_candidates = self.score(&hydrated_query, kept).await;

    // 6. 選択
    let selected_candidates = self.select(&hydrated_query, scored_candidates);

    // 7. ポストセレクションハイドレーション（並列）
    let final_hydrated = self.hydrate_post_selection(&hydrated_query, selected).await;

    // 8. ポストセレクションフィルタ（順次）
    let (final_candidates, _) = self.filter_post_selection(&hydrated_query, final_hydrated).await;

    // 9. サイドエフェクト（非同期バックグラウンド）
    self.run_side_effects(input);

    PipelineResult { ... }
}
```

---

## 4. 技術スタック

### 4.1 プログラミング言語

| 言語 | 用途 | バージョン |
|------|------|-----------|
| **Rust** | Home Mixer, Thunder, Candidate Pipeline | 安定版 |
| **Python** | Phoenix ML モデル | 3.10+ |

### 4.2 機械学習フレームワーク

| フレームワーク | 用途 |
|---------------|------|
| **JAX** | 高性能数値計算、自動微分 |
| **Haiku** | JAX上のニューラルネットワークライブラリ |

### 4.3 通信・メッセージング

| 技術 | 用途 |
|------|------|
| **gRPC** | サービス間通信（Home Mixer, Thunder, Phoenix間） |
| **Protocol Buffers** | データシリアライゼーション |
| **Kafka** | リアルタイムイベントストリーミング（投稿イベント） |

### 4.4 Webサーバー・フレームワーク

| 技術 | 用途 |
|------|------|
| **Tonic** | Rust gRPCフレームワーク |
| **Axum** | Rust HTTPフレームワーク |
| **Tokio** | 非同期ランタイム |

### 4.5 データ圧縮

| 形式 | 用途 |
|------|------|
| **gzip** | gRPCメッセージ圧縮 |
| **Zstd** | gRPCメッセージ圧縮（高効率） |

### 4.6 技術スタック図

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              技術スタック                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                        アプリケーション層                           │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌───────────────────────────┐   │    │
│  │  │ Home Mixer  │  │   Thunder   │  │        Phoenix            │   │    │
│  │  │   (Rust)    │  │   (Rust)    │  │    (Python/JAX/Haiku)     │   │    │
│  │  └─────────────┘  └─────────────┘  └───────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    │                                        │
│  ┌─────────────────────────────────┼───────────────────────────────────┐    │
│  │                      フレームワーク層                               │    │
│  │  ┌─────────────────┐  ┌────────────────┐  ┌───────────────────┐    │    │
│  │  │ Candidate       │  │     Tonic      │  │    Axum           │    │    │
│  │  │ Pipeline        │  │   (gRPC)       │  │    (HTTP)         │    │    │
│  │  │ (Rust)          │  │                │  │                   │    │    │
│  │  └─────────────────┘  └────────────────┘  └───────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    │                                        │
│  ┌─────────────────────────────────┼───────────────────────────────────┐    │
│  │                        ランタイム層                                 │    │
│  │  ┌─────────────────────────────────┐  ┌────────────────────────┐   │    │
│  │  │            Tokio                │  │         JAX            │   │    │
│  │  │    (Rust 非同期ランタイム)      │  │   (Python数値計算)     │   │    │
│  │  └─────────────────────────────────┘  └────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    │                                        │
│  ┌─────────────────────────────────┼───────────────────────────────────┐    │
│  │                    インフラストラクチャ層                           │    │
│  │  ┌───────────────────┐  ┌───────────────────┐  ┌────────────────┐  │    │
│  │  │      Kafka        │  │   Protocol        │  │   gzip/Zstd    │  │    │
│  │  │  (イベント        │  │   Buffers         │  │   (圧縮)       │  │    │
│  │  │   ストリーム)     │  │   (シリアライズ)  │  │                │  │    │
│  │  └───────────────────┘  └───────────────────┘  └────────────────┘  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. システム全体の目的と設計思想

### 5.1 設計目標

#### 5.1.1 ユーザー体験の最適化

- **パーソナライゼーション**: 各ユーザーの興味・関心に合わせたコンテンツ提供
- **発見性**: フォロー外の関連コンテンツを適切に提示
- **多様性**: 単一著者のコンテンツ偏重を防止

#### 5.1.2 技術的優位性

- **スケーラビリティ**: 数億ユーザー規模に対応
- **レイテンシ**: サブミリ秒〜数十ミリ秒でのレスポンス
- **柔軟性**: 新しいソース、フィルタ、スコアラーの容易な追加

### 5.2 主要な設計決定

#### 5.2.1 手動特徴量エンジニアリングの排除

```
従来のアプローチ:
┌────────────────┐     ┌────────────────┐     ┌────────────────┐
│ 生データ       │ ──▶ │ 手動特徴量     │ ──▶ │ MLモデル       │
│                │     │ エンジニアリング│     │                │
└────────────────┘     └────────────────┘     └────────────────┘
                              ↑
                       ドメイン知識・仮説が必要

本システムのアプローチ:
┌────────────────┐     ┌────────────────────────────────────────┐
│ エンゲージメント│ ──▶ │ Grokベース Transformer                 │
│ 履歴シーケンス │     │ (特徴量学習を自動化)                   │
└────────────────┘     └────────────────────────────────────────┘
```

**メリット:**
- データパイプラインの複雑性削減
- サービングインフラの簡素化
- モデルが関連性を自動学習

#### 5.2.2 ランキングにおける候補分離

```
問題: 候補間の相互参照がある場合
┌─────────┐
│ 候補 A  │──┐
├─────────┤  │ 相互参照
│ 候補 B  │◀─┤     → スコアがバッチ構成に依存
├─────────┤  │        → キャッシュ不可
│ 候補 C  │──┘        → 不安定な結果
└─────────┘

解決策: 候補分離マスク
┌─────────┐
│ 候補 A  │ ──▶ ユーザーコンテキストのみ参照
├─────────┤
│ 候補 B  │ ──▶ ユーザーコンテキストのみ参照
├─────────┤
│ 候補 C  │ ──▶ ユーザーコンテキストのみ参照
└─────────┘
     ↓
 スコアが一貫性を持ち、キャッシュ可能
```

#### 5.2.3 ハッシュベースエンベディング

検索とランキングの両方で、複数のハッシュ関数を使用したエンベディングルックアップを採用:

```
入力ID
   │
   ├──▶ Hash1 ──▶ Embedding1 ──┐
   │                           │
   ├──▶ Hash2 ──▶ Embedding2 ──┼──▶ 射影行列 ──▶ 最終エンベディング
   │                           │
   └──▶ Hash3 ──▶ Embedding3 ──┘
```

#### 5.2.4 マルチアクション予測

単一の「関連性」スコアではなく、複数のエンゲージメントタイプの確率を予測:

```
予測出力: [B, num_candidates, num_actions]

┌─────────────────────────────────────────────────────────────────────┐
│ favorite │ reply │ repost │ quote │ click │ dwell │ follow │ ... │
│  P(like) │P(repl)│P(repo) │P(quot)│P(clk) │P(dwel)│P(folw) │     │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
              ┌───────────────────────────────────────┐
              │ Weighted Score = Σ (weight × P(action)) │
              │                                       │
              │ ポジティブ: +weight                    │
              │ ネガティブ: -weight                    │
              └───────────────────────────────────────┘
```

#### 5.2.5 構成可能なパイプラインアーキテクチャ

```
┌─────────────────────────────────────────────────────────────────────┐
│                    Candidate Pipeline Framework                      │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐   │
│  │ Source  │  │Hydrator │  │ Filter  │  │ Scorer  │  │Selector │   │
│  │  Trait  │  │  Trait  │  │  Trait  │  │  Trait  │  │  Trait  │   │
│  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘   │
│       │            │            │            │            │        │
│       ▼            ▼            ▼            ▼            ▼        │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐   │
│  │Thunder  │  │CoreData │  │  Age    │  │ Phoenix │  │ Top-K   │   │
│  │Source   │  │Hydrator │  │ Filter  │  │ Scorer  │  │Selector │   │
│  ├─────────┤  ├─────────┤  ├─────────┤  ├─────────┤  └─────────┘   │
│  │Phoenix  │  │Gizmoduck│  │ Muted   │  │Weighted │                │
│  │Source   │  │Hydrator │  │ Filter  │  │ Scorer  │                │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘                │
│                                                                     │
│  特徴:                                                              │
│  • パイプライン実行とモニタリングをビジネスロジックから分離         │
│  • 独立ステージの並列実行とグレースフルエラーハンドリング           │
│  • 新しいソース、ハイドレーション、フィルタ、スコアラーの容易な追加 │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 6. データフロー概要

### 6.1 詳細データフロー図

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    FOR YOU FEED REQUEST                                     │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
                                               │
                                               ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                                         HOME MIXER                                          │
│                                    (Orchestration Layer)                                    │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                   QUERY HYDRATION                                   │   │
│   │  ┌──────────────────────────┐    ┌──────────────────────────────────────────────┐   │   │
│   │  │ User Action Sequence     │    │ User Features                                │   │   │
│   │  │ (エンゲージメント履歴)    │    │ (フォローリスト、設定など)                   │   │   │
│   │  └──────────────────────────┘    └──────────────────────────────────────────────┘   │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              │                                              │
│                                              ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                  CANDIDATE SOURCES                                  │   │
│   │         ┌─────────────────────────────┐    ┌────────────────────────────────┐       │   │
│   │         │        THUNDER              │    │     PHOENIX RETRIEVAL          │       │   │
│   │         │    (In-Network Posts)       │    │   (Out-of-Network Posts)       │       │   │
│   │         │                             │    │                                │       │   │
│   │         │  フォローアカウントの       │    │  Two-Tower Modelによる         │       │   │
│   │         │  投稿を高速検索             │    │  類似度検索                    │       │   │
│   │         │                             │    │                                │       │   │
│   │         │  ┌─────────────────────┐    │    │  ┌────────────────────────┐   │       │   │
│   │         │  │ Kafka Consumer      │    │    │  │ User Tower (Transformer)│  │       │   │
│   │         │  │     ↓               │    │    │  │     × Candidate Tower  │  │       │   │
│   │         │  │ In-Memory Store     │    │    │  │     → Dot Product      │  │       │   │
│   │         │  │     ↓               │    │    │  │     → Top-K            │  │       │   │
│   │         │  │ gRPC Response       │    │    │  └────────────────────────┘   │       │   │
│   │         │  └─────────────────────┘    │    │                                │       │   │
│   │         └─────────────────────────────┘    └────────────────────────────────┘       │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              │                                              │
│                                              ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                      HYDRATION                                      │   │
│   │  投稿メタデータ、著者情報、メディアエンティティ等を追加取得                          │   │
│   │  ┌────────────────┐ ┌────────────────┐ ┌────────────────┐ ┌────────────────┐        │   │
│   │  │ CoreData       │ │ Gizmoduck      │ │ Subscription   │ │ VideoDuration  │        │   │
│   │  │ Hydrator       │ │ Hydrator       │ │ Hydrator       │ │ Hydrator       │        │   │
│   │  └────────────────┘ └────────────────┘ └────────────────┘ └────────────────┘        │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              │                                              │
│                                              ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                PRE-SCORING FILTERING                                │   │
│   │  重複、古い投稿、自己投稿、ブロック著者、ミュートキーワード等を除去                   │   │
│   │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐               │   │
│   │  │ DropDuplicates│ │ AgeFilter   │ │ MutedKeyword │ │ SocialGraph  │               │   │
│   │  │ Filter        │ │             │ │ Filter       │ │ Filter       │               │   │
│   │  └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘               │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              │                                              │
│                                              ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                       SCORING                                       │   │
│   │                                                                                     │   │
│   │  ┌──────────────────────────┐                                                       │   │
│   │  │  Phoenix Scorer          │    Grok-based Transformer が予測:                     │   │
│   │  │  (ML Predictions)        │    P(like), P(reply), P(repost), P(click)...          │   │
│   │  └──────────────────────────┘                                                       │   │
│   │               │                                                                     │   │
│   │               ▼                                                                     │   │
│   │  ┌──────────────────────────┐                                                       │   │
│   │  │  Weighted Scorer         │    Weighted Score = Σ (weight × P(action))            │   │
│   │  │  (Combine predictions)   │    ポジティブ: +weight / ネガティブ: -weight          │   │
│   │  └──────────────────────────┘                                                       │   │
│   │               │                                                                     │   │
│   │               ▼                                                                     │   │
│   │  ┌──────────────────────────┐                                                       │   │
│   │  │  Author Diversity        │    同一著者のスコアを減衰                             │   │
│   │  │  Scorer                  │    フィードの多様性を確保                             │   │
│   │  └──────────────────────────┘                                                       │   │
│   │               │                                                                     │   │
│   │               ▼                                                                     │   │
│   │  ┌──────────────────────────┐                                                       │   │
│   │  │  OON Scorer              │    Out-of-Network コンテンツの                        │   │
│   │  │                          │    スコア調整                                         │   │
│   │  └──────────────────────────┘                                                       │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              │                                              │
│                                              ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                      SELECTION                                      │   │
│   │                    最終スコアでソートし、上位K件を選択                               │   │
│   │                         (TopKScoreSelector)                                         │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              │                                              │
│                                              ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                              POST-SELECTION FILTERING                               │   │
│   │  ┌──────────────────────────┐    ┌──────────────────────────────────────────────┐   │   │
│   │  │ VFFilter                 │    │ DedupConversationFilter                      │   │   │
│   │  │ (削除/スパム/暴力等)     │    │ (会話スレッドの重複排除)                     │   │   │
│   │  └──────────────────────────┘    └──────────────────────────────────────────────┘   │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              │                                              │
│                                              ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                    SIDE EFFECTS                                     │   │
│   │                        (非同期: キャッシュ更新、ログ記録など)                        │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
                                               │
                                               ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                                     RANKED FEED RESPONSE                                    │
│                                  (gRPC: ScoredPostsService)                                 │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 コンポーネント間通信

```
┌──────────────────────────────────────────────────────────────────────────────────────┐
│                              コンポーネント間通信                                     │
├──────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│                                                                                      │
│      ┌─────────────┐                                                                 │
│      │   Kafka     │                                                                 │
│      │ (Events)    │                                                                 │
│      └──────┬──────┘                                                                 │
│             │ 投稿イベント                                                           │
│             │ (create/delete)                                                        │
│             ▼                                                                        │
│      ┌─────────────┐     gRPC (InNetworkPostsService)     ┌─────────────┐           │
│      │   THUNDER   │◀─────────────────────────────────────│ HOME MIXER  │           │
│      │             │                                      │             │           │
│      │ In-Memory   │                                      │ Orchestrator│           │
│      │ Post Store  │                                      │             │           │
│      └─────────────┘                                      └──────┬──────┘           │
│                                                                  │                  │
│                                                                  │                  │
│      ┌─────────────────────────────────────────────────────────┐│                  │
│      │                       PHOENIX                           ││                  │
│      │  ┌─────────────────┐      ┌─────────────────┐          ││                  │
│      │  │    Retrieval    │      │     Ranking     │          ││                  │
│      │  │    Service      │◀─────│     Service     │◀─────────┘│                  │
│      │  │                 │      │                 │           │                  │
│      │  │  Two-Tower      │      │  Transformer    │ gRPC      │                  │
│      │  │  Model          │      │  (Grok-based)   │           │                  │
│      │  └─────────────────┘      └─────────────────┘           │                  │
│      └─────────────────────────────────────────────────────────┘                  │
│                                                                                      │
│      プロトコル: gRPC (Protocol Buffers)                                             │
│      圧縮: gzip, Zstd                                                               │
│      認証: 内部サービス間認証                                                        │
│                                                                                      │
└──────────────────────────────────────────────────────────────────────────────────────┘
```

### 6.3 Thunderデータフロー（リアルタイム取り込み）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         THUNDER DATA FLOW                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌──────────────┐                                                          │
│   │  外部システム │                                                          │
│   │  (投稿作成)  │                                                          │
│   └──────┬───────┘                                                          │
│          │                                                                  │
│          ▼                                                                  │
│   ┌──────────────┐                                                          │
│   │    KAFKA     │                                                          │
│   │  tweet_events│                                                          │
│   │   topic      │                                                          │
│   └──────┬───────┘                                                          │
│          │                                                                  │
│          ▼                                                                  │
│   ┌──────────────────────────────────────────────────────────────────┐      │
│   │                    THUNDER SERVICE                               │      │
│   │  ┌──────────────────┐                                            │      │
│   │  │ Kafka Consumer   │─────────┐                                  │      │
│   │  │ (複数スレッド)   │         │                                  │      │
│   │  └──────────────────┘         │                                  │      │
│   │          │                    │                                  │      │
│   │          ▼                    ▼                                  │      │
│   │  ┌──────────────────┐  ┌──────────────────┐                      │      │
│   │  │   Deserializer   │  │   Deserializer   │  ... (並列処理)      │      │
│   │  └────────┬─────────┘  └────────┬─────────┘                      │      │
│   │           │                     │                                │      │
│   │           └──────────┬──────────┘                                │      │
│   │                      │                                           │      │
│   │                      ▼                                           │      │
│   │  ┌─────────────────────────────────────────────────────────┐     │      │
│   │  │                    POST STORE                           │     │      │
│   │  │  ┌─────────────────┐  ┌─────────────────┐              │     │      │
│   │  │  │ User → Posts    │  │ User → Videos   │              │     │      │
│   │  │  │ (HashMap)       │  │ (HashMap)       │              │     │      │
│   │  │  └─────────────────┘  └─────────────────┘              │     │      │
│   │  │                                                         │     │      │
│   │  │  ┌─────────────────────────────────────────────────┐   │     │      │
│   │  │  │ Auto-Trim Task (2分間隔)                        │   │     │      │
│   │  │  │ 保持期間超過の投稿を自動削除                    │   │     │      │
│   │  │  └─────────────────────────────────────────────────┘   │     │      │
│   │  └─────────────────────────────────────────────────────────┘     │      │
│   │                      │                                           │      │
│   │                      ▼                                           │      │
│   │  ┌──────────────────────────────────────────────────────────┐    │      │
│   │  │                gRPC Server                               │    │      │
│   │  │          (InNetworkPostsService)                         │    │      │
│   │  │                                                          │    │      │
│   │  │  get_in_network_posts(user_id, following_ids)            │    │      │
│   │  │       → サブミリ秒でイン・ネットワーク投稿を返却         │    │      │
│   │  └──────────────────────────────────────────────────────────┘    │      │
│   └──────────────────────────────────────────────────────────────────┘      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.4 Phoenixモデルデータフロー

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              PHOENIX MODEL DATA FLOW                                 │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  入力データ                                                                          │
│  ┌──────────────────────────────────────────────────────────────────────────────┐   │
│  │  RecsysBatch                                                                 │   │
│  │  ├── user_hashes: [B, num_user_hashes]                                       │   │
│  │  ├── history_post_hashes: [B, S, num_item_hashes]                           │   │
│  │  ├── history_author_hashes: [B, S, num_author_hashes]                       │   │
│  │  ├── history_actions: [B, S, num_actions]  (multi-hot)                      │   │
│  │  ├── history_product_surface: [B, S]                                        │   │
│  │  ├── candidate_post_hashes: [B, C, num_item_hashes]                         │   │
│  │  ├── candidate_author_hashes: [B, C, num_author_hashes]                     │   │
│  │  └── candidate_product_surface: [B, C]                                      │   │
│  └──────────────────────────────────────────────────────────────────────────────┘   │
│                                         │                                           │
│                                         ▼                                           │
│  ┌──────────────────────────────────────────────────────────────────────────────┐   │
│  │                        EMBEDDING LOOKUP                                      │   │
│  │                                                                              │   │
│  │   Hash IDs ─────▶ Embedding Tables ─────▶ RecsysEmbeddings                   │   │
│  │                                                                              │   │
│  │   user_embeddings: [B, num_user_hashes, D]                                   │   │
│  │   history_post_embeddings: [B, S, num_item_hashes, D]                        │   │
│  │   history_author_embeddings: [B, S, num_author_hashes, D]                    │   │
│  │   candidate_post_embeddings: [B, C, num_item_hashes, D]                      │   │
│  │   candidate_author_embeddings: [B, C, num_author_hashes, D]                  │   │
│  └──────────────────────────────────────────────────────────────────────────────┘   │
│                                         │                                           │
│                                         ▼                                           │
│  ┌──────────────────────────────────────────────────────────────────────────────┐   │
│  │                        BLOCK REDUCE                                          │   │
│  │                                                                              │   │
│  │   block_user_reduce:                                                         │   │
│  │     [B, num_user_hashes, D] ─▶ 射影 ─▶ [B, 1, D]                            │   │
│  │                                                                              │   │
│  │   block_history_reduce:                                                      │   │
│  │     post + author + actions + surface ─▶ 射影 ─▶ [B, S, D]                  │   │
│  │                                                                              │   │
│  │   block_candidate_reduce:                                                    │   │
│  │     post + author + surface ─▶ 射影 ─▶ [B, C, D]                            │   │
│  └──────────────────────────────────────────────────────────────────────────────┘   │
│                                         │                                           │
│                                         ▼                                           │
│  ┌──────────────────────────────────────────────────────────────────────────────┐   │
│  │                        CONCATENATE                                           │   │
│  │                                                                              │   │
│  │   [User: 1] + [History: S] + [Candidates: C] ─▶ [B, 1+S+C, D]               │   │
│  └──────────────────────────────────────────────────────────────────────────────┘   │
│                                         │                                           │
│                                         ▼                                           │
│  ┌──────────────────────────────────────────────────────────────────────────────┐   │
│  │                        TRANSFORMER                                           │   │
│  │                  (Grok-based with Candidate Isolation Mask)                  │   │
│  │                                                                              │   │
│  │   Attention Mask:                                                            │   │
│  │   ┌────────────────────────────────────────────────────────────────┐         │   │
│  │   │ User+History: 双方向アテンション                              │         │   │
│  │   │ Candidates → User+History: 可                                 │         │   │
│  │   │ Candidates → Candidates: 不可 (自己のみ)                      │         │   │
│  │   └────────────────────────────────────────────────────────────────┘         │   │
│  │                                                                              │   │
│  │   Output: [B, 1+S+C, D]                                                      │   │
│  └──────────────────────────────────────────────────────────────────────────────┘   │
│                                         │                                           │
│                                         ▼                                           │
│  ┌──────────────────────────────────────────────────────────────────────────────┐   │
│  │                        EXTRACT + UNEMBED                                     │   │
│  │                                                                              │   │
│  │   candidate_embeddings = output[:, candidate_start_offset:, :]               │   │
│  │                                                                              │   │
│  │   layer_norm ─▶ unembedding ─▶ logits                                        │   │
│  │                                                                              │   │
│  │   Output: [B, C, num_actions]                                                │   │
│  │                                                                              │   │
│  │   各候補に対する各アクションの確率                                            │   │
│  └──────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 付録

### A. 用語集

| 用語 | 説明 |
|------|------|
| **イン・ネットワーク** | ユーザーがフォローしているアカウントからのコンテンツ |
| **アウト・オブ・ネットワーク** | フォロー外のアカウントからのコンテンツ |
| **候補分離** | ランキング時に候補同士が互いに参照できないようにする設計 |
| **Two-Tower Model** | ユーザーとアイテムを別々のタワーでエンコードする検索モデル |
| **ハイドレーション** | 候補データに追加情報を付与するプロセス |
| **ANN** | Approximate Nearest Neighbor（近似最近傍探索） |

### B. 関連ドキュメント

- [Grok-1 Open Source](https://github.com/xai-org/grok-1)
- [Phoenix README](../../phoenix/README.md)
- [Apache License 2.0](../../LICENSE)

### C. 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|----------|
| 1.0 | 2026年1月 | 初版作成 |

---

**Copyright 2026 X.AI Corp. - Licensed under Apache License 2.0**
