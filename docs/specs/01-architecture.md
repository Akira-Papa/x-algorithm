# X For You フィードアルゴリズム - アーキテクチャ仕様書

**バージョン**: 1.0
**最終更新日**: 2026-01-21
**ステータス**: 公開

---

## 目次

1. [概要](#1-概要)
2. [システムアーキテクチャ全体図](#2-システムアーキテクチャ全体図)
3. [8段階パイプライン詳細](#3-8段階パイプライン詳細)
4. [gRPCサービス構成](#4-grpcサービス構成)
5. [データモデルとスキーマ](#5-データモデルとスキーマ)
6. [コンポーネント間の通信フロー](#6-コンポーネント間の通信フロー)
7. [MLモデルアーキテクチャ](#7-mlモデルアーキテクチャ)
8. [運用考慮事項](#8-運用考慮事項)

---

## 1. 概要

X For You フィードアルゴリズムは、ユーザーに最も関連性の高いコンテンツを提供する推薦システムです。本システムは以下の2つのソースからコンテンツを取得し、Grokベースのトランスフォーマーモデル (Phoenix) を使用してランキングを行います。

### 1.1 主要コンポーネント

| コンポーネント | 役割 | 実装言語 |
|--------------|------|---------|
| **Home Mixer** | オーケストレーション層、パイプライン実行 | Rust |
| **Thunder** | インネットワーク投稿のリアルタイム配信 | Rust |
| **Phoenix** | ML予測（検索・ランキング） | Python/JAX |
| **Candidate Pipeline** | パイプラインフレームワーク | Rust |

### 1.2 設計原則

- **手作業による特徴量エンジニアリングの排除**: Grokトランスフォーマーがユーザーのエンゲージメント履歴から関連性を学習
- **候補間の独立性**: ランキング時、候補同士はアテンションしない（スコアの一貫性とキャッシャビリティを確保）
- **ハッシュベース埋め込み**: 複数のハッシュ関数による埋め込みルックアップ
- **マルチアクション予測**: 単一の関連性スコアではなく、複数のアクション確率を予測

---

## 2. システムアーキテクチャ全体図

### 2.1 高レベルアーキテクチャ

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                        クライアントリクエスト                                         │
│                                     (iOS / Android / Web App)                                        │
└─────────────────────────────────────────────────────────────────────────────────────────────────────┘
                                                   │
                                                   ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                         API Gateway Layer                                            │
│                                    (認証・レート制限・ルーティング)                                    │
└─────────────────────────────────────────────────────────────────────────────────────────────────────┘
                                                   │
                                                   ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                     │
│   ┌───────────────────────────────────────────────────────────────────────────────────────────┐     │
│   │                              HOME MIXER (オーケストレーション層)                             │     │
│   │                                     gRPC: ScoredPostsService                               │     │
│   ├───────────────────────────────────────────────────────────────────────────────────────────┤     │
│   │                                                                                           │     │
│   │   [1] QUERY HYDRATION                                                                     │     │
│   │       │                                                                                   │     │
│   │       ├── UserActionSeqQueryHydrator (エンゲージメント履歴)                                │     │
│   │       └── UserFeaturesQueryHydrator (フォローリスト、設定等)                               │     │
│   │                                                                                           │     │
│   │   [2] CANDIDATE SOURCES ──────────────────────────────────────────────────────────────┐   │     │
│   │       │                                                                               │   │     │
│   │       │  ┌─────────────────────────┐        ┌─────────────────────────────────┐       │   │     │
│   │       ├──│      THUNDER            │        │       PHOENIX RETRIEVAL         │───────┤   │     │
│   │       │  │  (In-Network Posts)     │        │    (Out-of-Network Posts)       │       │   │     │
│   │       │  │                         │        │                                 │       │   │     │
│   │       │  │  - メモリ内ポストストア  │        │  - Two-Tower モデル             │       │   │     │
│   │       │  │  - Kafkaリアルタイム取込 │        │  - ANN類似検索                  │       │   │     │
│   │       │  │  - ユーザー別インデックス│        │  - グローバルコーパス           │       │   │     │
│   │       │  └─────────────────────────┘        └─────────────────────────────────┘       │   │     │
│   │       └───────────────────────────────────────────────────────────────────────────────┘   │     │
│   │                                                                                           │     │
│   │   [3] HYDRATION ─────────────────────────────────────────────────────────────────────────│     │
│   │       │                                                                                   │     │
│   │       ├── CoreDataCandidateHydrator (投稿メタデータ)                                      │     │
│   │       ├── GizmoduckCandidateHydrator (著者情報)                                          │     │
│   │       ├── VideoDurationCandidateHydrator (動画長)                                        │     │
│   │       ├── SubscriptionHydrator (サブスクリプション状態)                                  │     │
│   │       └── InNetworkCandidateHydrator (ネットワーク内フラグ)                              │     │
│   │                                                                                           │     │
│   │   [4] PRE-SCORING FILTERS ───────────────────────────────────────────────────────────────│     │
│   │       │                                                                                   │     │
│   │       ├── DropDuplicatesFilter         ├── PreviouslySeenPostsFilter                     │     │
│   │       ├── CoreDataHydrationFilter      ├── PreviouslyServedPostsFilter                   │     │
│   │       ├── AgeFilter                    ├── MutedKeywordFilter                            │     │
│   │       ├── SelfTweetFilter              └── AuthorSocialgraphFilter                       │     │
│   │       ├── RetweetDeduplicationFilter                                                     │     │
│   │       └── IneligibleSubscriptionFilter                                                   │     │
│   │                                                                                           │     │
│   │   [5] SCORING ───────────────────────────────────────────────────────────────────────────│     │
│   │       │                                                                                   │     │
│   │       │   ┌────────────────────────────────────────────────────────────────────────┐     │     │
│   │       │   │                      PHOENIX SCORER                                     │     │     │
│   │       │   │   ┌─────────────────────────────────────────────────────────────┐       │     │     │
│   │       │   │   │    Grok Transformer (Candidate Isolation Attention)         │       │     │     │
│   │       │   │   │                                                             │       │     │     │
│   │       │   │   │    予測出力:                                                │       │     │     │
│   │       │   │   │    P(favorite), P(reply), P(retweet), P(quote),            │       │     │     │
│   │       │   │   │    P(click), P(profile_click), P(video_view),              │       │     │     │
│   │       │   │   │    P(photo_expand), P(share), P(dwell),                    │       │     │     │
│   │       │   │   │    P(follow_author), P(not_interested),                    │       │     │     │
│   │       │   │   │    P(block_author), P(mute_author), P(report)              │       │     │     │
│   │       │   │   └─────────────────────────────────────────────────────────────┘       │     │     │
│   │       │   └────────────────────────────────────────────────────────────────────────┘     │     │
│   │       │                               │                                                   │     │
│   │       │                               ▼                                                   │     │
│   │       │   ┌────────────────────────────────────────────────────────────────────────┐     │     │
│   │       │   │  WEIGHTED SCORER: Final Score = Σ (weight_i × P(action_i))             │     │     │
│   │       │   └────────────────────────────────────────────────────────────────────────┘     │     │
│   │       │                               │                                                   │     │
│   │       │                               ▼                                                   │     │
│   │       │   ┌────────────────────────────────────────────────────────────────────────┐     │     │
│   │       │   │  AUTHOR DIVERSITY SCORER: 同一著者の繰り返しスコア減衰                  │     │     │
│   │       │   └────────────────────────────────────────────────────────────────────────┘     │     │
│   │       │                               │                                                   │     │
│   │       │                               ▼                                                   │     │
│   │       │   ┌────────────────────────────────────────────────────────────────────────┐     │     │
│   │       │   │  OON SCORER: Out-of-Network コンテンツのスコア調整                      │     │     │
│   │       │   └────────────────────────────────────────────────────────────────────────┘     │     │
│   │       │                                                                                   │     │
│   │   [6] SELECTION ─────────────────────────────────────────────────────────────────────────│     │
│   │       │                                                                                   │     │
│   │       └── TopKScoreSelector: スコア順ソート、上位K件選択                                  │     │
│   │                                                                                           │     │
│   │   [7] POST-SELECTION PROCESSING ─────────────────────────────────────────────────────────│     │
│   │       │                                                                                   │     │
│   │       ├── VFCandidateHydrator (Visibility Filtering データ)                              │     │
│   │       ├── VFFilter (削除/スパム/暴力コンテンツ除外)                                       │     │
│   │       └── DedupConversationFilter (会話スレッド重複排除)                                  │     │
│   │                                                                                           │     │
│   │   [8] SIDE EFFECTS ──────────────────────────────────────────────────────────────────────│     │
│   │       │                                                                                   │     │
│   │       └── CacheRequestInfoSideEffect (リクエスト情報キャッシュ)                           │     │
│   │                                                                                           │     │
│   └───────────────────────────────────────────────────────────────────────────────────────────┘     │
│                                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────────────────────┘
                                                   │
                                                   ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                     RANKED FEED RESPONSE                                             │
│                                   (スコア付き投稿リスト返却)                                          │
└─────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 コンポーネント間通信図

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    外部クライアント / API Gateway                                    │
└─────────────────────────────────────────────────────────────────────────────────────────────────────┘
                                                   │
                                            gRPC (HTTP/2)
                                                   │
                                                   ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                     │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                    HOME MIXER                                                │   │
│   │                              (ScoredPostsService)                                            │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                     │
│          │                    │                    │                    │                           │
│          │                    │                    │                    │                           │
│          ▼                    ▼                    ▼                    ▼                           │
│   ┌──────────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐                     │
│   │   THUNDER    │    │   PHOENIX    │    │   PHOENIX    │    │   EXTERNAL   │                     │
│   │   SERVICE    │    │  RETRIEVAL   │    │   RANKING    │    │   SERVICES   │                     │
│   │              │    │   SERVICE    │    │   SERVICE    │    │              │                     │
│   │  gRPC:       │    │              │    │              │    │ - Gizmoduck  │                     │
│   │ InNetwork    │    │  gRPC:       │    │  gRPC:       │    │ - TES        │                     │
│   │ PostsService │    │ Retrieval    │    │ Prediction   │    │ - Strato     │                     │
│   │              │    │ Service      │    │ Service      │    │ - SocialGraph│                     │
│   └──────────────┘    └──────────────┘    └──────────────┘    │ - VF         │                     │
│          │                    │                    │          └──────────────┘                     │
│          │                    │                    │                    │                           │
│          ▼                    ▼                    ▼                    ▼                           │
│   ┌──────────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐                     │
│   │  POST STORE  │    │  CORPUS      │    │  ML MODEL    │    │  各種DB/     │                     │
│   │  (In-Memory) │    │  EMBEDDINGS  │    │  (JAX/Grok)  │    │  キャッシュ   │                     │
│   └──────────────┘    └──────────────┘    └──────────────┘    └──────────────┘                     │
│          ▲                                                                                          │
│          │                                                                                          │
│    ┌─────┴─────┐                                                                                    │
│    │   KAFKA   │                                                                                    │
│    │  (Tweet   │                                                                                    │
│    │  Events)  │                                                                                    │
│    └───────────┘                                                                                    │
│                                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 8段階パイプライン詳細

### 3.1 Stage 1: Query Hydration

**目的**: リクエストに必要なユーザーコンテキスト情報を取得

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              QUERY HYDRATION STAGE                                       │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   Input: ScoredPostsQuery                                                               │
│   ├── user_id: i64                                                                      │
│   ├── client_app_id: i32                                                                │
│   ├── country_code: String                                                              │
│   ├── language_code: String                                                             │
│   ├── seen_ids: Vec<i64>                                                                │
│   ├── served_ids: Vec<i64>                                                              │
│   ├── in_network_only: bool                                                             │
│   ├── is_bottom_request: bool                                                           │
│   └── bloom_filter_entries: Vec<ImpressionBloomFilterEntry>                             │
│                                                                                         │
│                           ┌──────────────────────────┐                                  │
│                           │                          │                                  │
│                           ▼                          ▼                                  │
│   ┌───────────────────────────────────┐  ┌───────────────────────────────────┐          │
│   │   UserActionSeqQueryHydrator      │  │   UserFeaturesQueryHydrator       │          │
│   │                                   │  │                                   │          │
│   │   - UAS Fetcher からデータ取得    │  │   - Strato Client から取得        │          │
│   │   - エンゲージメント履歴         │  │   - フォローリスト                │          │
│   │   - いいね/RT/リプライ履歴       │  │   - ミュートキーワード            │          │
│   │   - クリック/滞在時間履歴        │  │   - ブロック/ミュートリスト        │          │
│   │                                   │  │   - ユーザー設定                 │          │
│   └───────────────────────────────────┘  └───────────────────────────────────┘          │
│                           │                          │                                  │
│                           └──────────┬───────────────┘                                  │
│                                      ▼                                                  │
│   Output: Hydrated ScoredPostsQuery                                                     │
│   ├── user_action_sequence: Option<UserActionSequence>                                  │
│   └── user_features: UserFeatures                                                       │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

**Query Hydrators の並列実行**:
- 両方のHydratorは依存関係がないため、`join_all` で並列実行
- 各Hydratorの失敗は他に影響せず、エラーログ記録後に続行

### 3.2 Stage 2: Candidate Sources

**目的**: 2つのソースから候補投稿を取得

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              CANDIDATE SOURCES STAGE                                     │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   ┌────────────────────────────────────────┐  ┌────────────────────────────────────────┐│
│   │           THUNDER SOURCE               │  │          PHOENIX SOURCE                ││
│   │         (In-Network Posts)             │  │       (Out-of-Network Posts)           ││
│   ├────────────────────────────────────────┤  ├────────────────────────────────────────┤│
│   │                                        │  │                                        ││
│   │  ThunderService.get_in_network_posts() │  │  PhoenixRetrievalClient.retrieve()     ││
│   │                                        │  │                                        ││
│   │  ┌──────────────────────────────────┐  │  │  ┌──────────────────────────────────┐  ││
│   │  │      POST STORE (In-Memory)      │  │  │  │     TWO-TOWER MODEL              │  ││
│   │  ├──────────────────────────────────┤  │  │  ├──────────────────────────────────┤  ││
│   │  │                                  │  │  │  │                                  │  ││
│   │  │  ┌────────────────────────────┐  │  │  │  │  User Tower:                     │  ││
│   │  │  │  original_posts_by_user    │  │  │  │  │  user_features + history         │  ││
│   │  │  │  (オリジナル投稿)          │  │  │  │  │       ↓                          │  ││
│   │  │  └────────────────────────────┘  │  │  │  │  Transformer Encoding            │  ││
│   │  │                                  │  │  │  │       ↓                          │  ││
│   │  │  ┌────────────────────────────┐  │  │  │  │  User Embedding [B, D]           │  ││
│   │  │  │  secondary_posts_by_user   │  │  │  │  │                                  │  ││
│   │  │  │  (リプライ/RT)             │  │  │  │  │  Candidate Tower:                │  ││
│   │  │  └────────────────────────────┘  │  │  │  │  post + author embeddings        │  ││
│   │  │                                  │  │  │  │       ↓                          │  ││
│   │  │  ┌────────────────────────────┐  │  │  │  │  MLP Projection                  │  ││
│   │  │  │  video_posts_by_user       │  │  │  │  │       ↓                          │  ││
│   │  │  │  (動画投稿)                │  │  │  │  │  Corpus Embeddings [N, D]        │  ││
│   │  │  └────────────────────────────┘  │  │  │  │                                  │  ││
│   │  │                                  │  │  │  │  Similarity Search:              │  ││
│   │  │  DashMap<user_id, VecDeque>      │  │  │  │  dot(user_emb, corpus_emb.T)     │  ││
│   │  │  - O(1) ルックアップ             │  │  │  │       ↓                          │  ││
│   │  │  - 自動トリミング (retention)   │  │  │  │  Top-K Candidates                │  ││
│   │  │                                  │  │  │  │                                  │  ││
│   │  └──────────────────────────────────┘  │  │  └──────────────────────────────────┘  ││
│   │                                        │  │                                        ││
│   │  取得戦略:                             │  │  取得戦略:                             ││
│   │  - フォローユーザーの投稿を走査       │  │  - ユーザー埋め込みを計算             ││
│   │  - 作成日時でソート (新しい順)        │  │  - コーパスと内積計算                 ││
│   │  - max_results まで取得              │  │  - Top-K を ANN検索で取得             ││
│   │                                        │  │                                        ││
│   └────────────────────────────────────────┘  └────────────────────────────────────────┘│
│                           │                              │                              │
│                           └──────────────┬───────────────┘                              │
│                                          ▼                                              │
│                               Combined Candidates                                       │
│                               Vec<PostCandidate>                                        │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

**Thunder PostStore データ構造**:

```rust
pub struct PostStore {
    posts: Arc<DashMap<i64, LightPost>>,                    // post_id -> 完全なポストデータ
    original_posts_by_user: Arc<DashMap<i64, VecDeque<TinyPost>>>,  // user_id -> オリジナル投稿
    secondary_posts_by_user: Arc<DashMap<i64, VecDeque<TinyPost>>>, // user_id -> リプライ/RT
    video_posts_by_user: Arc<DashMap<i64, VecDeque<TinyPost>>>,     // user_id -> 動画投稿
    deleted_posts: Arc<DashMap<i64, bool>>,                         // 削除済み投稿
    retention_seconds: u64,                                         // 保持期間
    request_timeout: Duration,                                      // リクエストタイムアウト
}
```

### 3.3 Stage 3: Hydration

**目的**: 候補に追加データを付与

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                 HYDRATION STAGE                                          │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   Input: Vec<PostCandidate>                                                             │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│   │                          PARALLEL HYDRATION                                      │   │
│   │                                                                                 │   │
│   │   ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐     │   │
│   │   │ InNetwork           │  │ CoreData            │  │ VideoDuration       │     │   │
│   │   │ CandidateHydrator   │  │ CandidateHydrator   │  │ CandidateHydrator   │     │   │
│   │   ├─────────────────────┤  ├─────────────────────┤  ├─────────────────────┤     │   │
│   │   │                     │  │                     │  │                     │     │   │
│   │   │ - in_network フラグ │  │ - TES Client        │  │ - TES Client        │     │   │
│   │   │ - フォロー関係判定  │  │ - tweet_text        │  │ - video_duration_ms │     │   │
│   │   │                     │  │ - in_reply_to       │  │                     │     │   │
│   │   │                     │  │ - retweet info      │  │                     │     │   │
│   │   │                     │  │ - ancestor info     │  │                     │     │   │
│   │   └─────────────────────┘  └─────────────────────┘  └─────────────────────┘     │   │
│   │                                                                                 │   │
│   │   ┌─────────────────────┐  ┌─────────────────────┐                              │   │
│   │   │ Subscription        │  │ Gizmoduck           │                              │   │
│   │   │ Hydrator            │  │ CandidateHydrator   │                              │   │
│   │   ├─────────────────────┤  ├─────────────────────┤                              │   │
│   │   │                     │  │                     │                              │   │
│   │   │ - TES Client        │  │ - Gizmoduck Client  │                              │   │
│   │   │ - subscription_     │  │ - author_screen_    │                              │   │
│   │   │   author_id         │  │   name              │                              │   │
│   │   │ - ペイウォール情報   │  │ - followers_count  │                              │   │
│   │   │                     │  │ - retweeted_        │                              │   │
│   │   │                     │  │   screen_name       │                              │   │
│   │   └─────────────────────┘  └─────────────────────┘                              │   │
│   │                                                                                 │   │
│   └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
│   Output: Vec<PostCandidate> (enriched with additional data)                            │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

**Hydration 実行フロー**:
1. 各Hydratorを並列実行 (`join_all`)
2. 結果の長さが候補数と一致することを検証
3. 各候補に対してHydrator結果をマージ
4. エラー発生時はログ記録して続行

### 3.4 Stage 4: Pre-Scoring Filters

**目的**: スコアリング前に不適格な候補を除外

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                             PRE-SCORING FILTERS STAGE                                    │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   Input: Vec<PostCandidate>                                                             │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│   │                         SEQUENTIAL FILTER CHAIN                                  │   │
│   │                                                                                 │   │
│   │   ┌────────────────────────┐                                                    │   │
│   │   │  DropDuplicatesFilter  │ ──→ 重複投稿IDを除外                               │   │
│   │   └────────────────────────┘                                                    │   │
│   │              │                                                                  │   │
│   │              ▼                                                                  │   │
│   │   ┌────────────────────────┐                                                    │   │
│   │   │ CoreDataHydrationFilter│ ──→ コアメタデータ取得失敗の投稿を除外             │   │
│   │   └────────────────────────┘                                                    │   │
│   │              │                                                                  │   │
│   │              ▼                                                                  │   │
│   │   ┌────────────────────────┐                                                    │   │
│   │   │      AgeFilter         │ ──→ MAX_POST_AGE より古い投稿を除外               │   │
│   │   └────────────────────────┘                                                    │   │
│   │              │                                                                  │   │
│   │              ▼                                                                  │   │
│   │   ┌────────────────────────┐                                                    │   │
│   │   │    SelfTweetFilter     │ ──→ 自分自身の投稿を除外                          │   │
│   │   └────────────────────────┘                                                    │   │
│   │              │                                                                  │   │
│   │              ▼                                                                  │   │
│   │   ┌────────────────────────┐                                                    │   │
│   │   │RetweetDeduplicationFilter│ ──→ 同一コンテンツのRT重複を除外                │   │
│   │   └────────────────────────┘                                                    │   │
│   │              │                                                                  │   │
│   │              ▼                                                                  │   │
│   │   ┌────────────────────────┐                                                    │   │
│   │   │IneligibleSubscription  │ ──→ アクセス不可のペイウォールコンテンツを除外     │   │
│   │   │        Filter          │                                                    │   │
│   │   └────────────────────────┘                                                    │   │
│   │              │                                                                  │   │
│   │              ▼                                                                  │   │
│   │   ┌────────────────────────┐                                                    │   │
│   │   │PreviouslySeenPostsFilter│ ──→ 既読投稿を除外 (seen_ids)                    │   │
│   │   └────────────────────────┘                                                    │   │
│   │              │                                                                  │   │
│   │              ▼                                                                  │   │
│   │   ┌────────────────────────┐                                                    │   │
│   │   │PreviouslyServedPosts   │ ──→ 既配信投稿を除外 (served_ids)                 │   │
│   │   │       Filter           │                                                    │   │
│   │   └────────────────────────┘                                                    │   │
│   │              │                                                                  │   │
│   │              ▼                                                                  │   │
│   │   ┌────────────────────────┐                                                    │   │
│   │   │  MutedKeywordFilter    │ ──→ ミュートキーワード含む投稿を除外              │   │
│   │   └────────────────────────┘                                                    │   │
│   │              │                                                                  │   │
│   │              ▼                                                                  │   │
│   │   ┌────────────────────────┐                                                    │   │
│   │   │AuthorSocialgraphFilter │ ──→ ブロック/ミュート済み著者を除外               │   │
│   │   └────────────────────────┘                                                    │   │
│   │                                                                                 │   │
│   └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
│   Output: (kept: Vec<PostCandidate>, removed: Vec<PostCandidate>)                       │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

**Filter 実行ロジック**:
- フィルターは順次実行（前のフィルターの結果が次の入力）
- 各フィルターは `(kept, removed)` のタプルを返す
- エラー発生時はバックアップから復元して続行

### 3.5 Stage 5: Scoring

**目的**: ML予測を実行し、最終スコアを計算

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                  SCORING STAGE                                           │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   Input: Vec<PostCandidate>                                                             │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│   │                          SEQUENTIAL SCORER CHAIN                                 │   │
│   │                                                                                 │   │
│   │   ┌────────────────────────────────────────────────────────────────────────┐    │   │
│   │   │                         PHOENIX SCORER                                  │    │   │
│   │   │                                                                        │    │   │
│   │   │   PhoenixPredictionClient.predict(query, candidates)                   │    │   │
│   │   │                                                                        │    │   │
│   │   │   ┌────────────────────────────────────────────────────────────────┐   │    │   │
│   │   │   │              GROK TRANSFORMER MODEL                             │   │    │   │
│   │   │   │                                                                │   │    │   │
│   │   │   │   Input Construction:                                          │   │    │   │
│   │   │   │   ┌─────────────────────────────────────────────────────────┐  │   │    │   │
│   │   │   │   │ [User Emb] [History Emb...] [Candidate Emb...]          │  │   │    │   │
│   │   │   │   │    [1]         [S]              [C]                     │  │   │    │   │
│   │   │   │   └─────────────────────────────────────────────────────────┘  │   │    │   │
│   │   │   │                                                                │   │    │   │
│   │   │   │   Attention Mask (Candidate Isolation):                        │   │    │   │
│   │   │   │   ┌─────────────────────────────────────────────────────────┐  │   │    │   │
│   │   │   │   │        User  History  Candidates                        │  │   │    │   │
│   │   │   │   │  User    ✓      ✓         ✗                             │  │   │    │   │
│   │   │   │   │  History ✓      ✓         ✗                             │  │   │    │   │
│   │   │   │   │  Cand_1  ✓      ✓      ✓(self) ✗ ✗ ...                  │  │   │    │   │
│   │   │   │   │  Cand_2  ✓      ✓         ✗ ✓(self) ✗ ...               │  │   │    │   │
│   │   │   │   │  ...                                                    │  │   │    │   │
│   │   │   │   └─────────────────────────────────────────────────────────┘  │   │    │   │
│   │   │   │                                                                │   │    │   │
│   │   │   │   Output: [B, C, num_actions] logits                          │   │    │   │
│   │   │   └────────────────────────────────────────────────────────────────┘   │    │   │
│   │   │                                                                        │    │   │
│   │   │   → PhoenixScores 更新:                                                │    │   │
│   │   │     favorite_score, reply_score, retweet_score, click_score,          │    │   │
│   │   │     profile_click_score, vqv_score, share_score, dwell_score, etc.    │    │   │
│   │   │                                                                        │    │   │
│   │   └────────────────────────────────────────────────────────────────────────┘    │   │
│   │                                        │                                        │   │
│   │                                        ▼                                        │   │
│   │   ┌────────────────────────────────────────────────────────────────────────┐    │   │
│   │   │                        WEIGHTED SCORER                                  │    │   │
│   │   │                                                                        │    │   │
│   │   │   compute_weighted_score():                                            │    │   │
│   │   │                                                                        │    │   │
│   │   │   combined_score =                                                     │    │   │
│   │   │       favorite_score × FAVORITE_WEIGHT                                 │    │   │
│   │   │     + reply_score × REPLY_WEIGHT                                       │    │   │
│   │   │     + retweet_score × RETWEET_WEIGHT                                   │    │   │
│   │   │     + photo_expand_score × PHOTO_EXPAND_WEIGHT                         │    │   │
│   │   │     + click_score × CLICK_WEIGHT                                       │    │   │
│   │   │     + profile_click_score × PROFILE_CLICK_WEIGHT                       │    │   │
│   │   │     + vqv_score × VQV_WEIGHT (if video_duration > MIN)                 │    │   │
│   │   │     + share_score × SHARE_WEIGHT                                       │    │   │
│   │   │     + dwell_score × DWELL_WEIGHT                                       │    │   │
│   │   │     + follow_author_score × FOLLOW_AUTHOR_WEIGHT                       │    │   │
│   │   │     + not_interested_score × NOT_INTERESTED_WEIGHT (negative)          │    │   │
│   │   │     + block_author_score × BLOCK_AUTHOR_WEIGHT (negative)              │    │   │
│   │   │     + mute_author_score × MUTE_AUTHOR_WEIGHT (negative)                │    │   │
│   │   │     + report_score × REPORT_WEIGHT (negative)                          │    │   │
│   │   │                                                                        │    │   │
│   │   │   → weighted_score 更新                                                │    │   │
│   │   │                                                                        │    │   │
│   │   └────────────────────────────────────────────────────────────────────────┘    │   │
│   │                                        │                                        │   │
│   │                                        ▼                                        │   │
│   │   ┌────────────────────────────────────────────────────────────────────────┐    │   │
│   │   │                    AUTHOR DIVERSITY SCORER                              │    │   │
│   │   │                                                                        │    │   │
│   │   │   同一著者の投稿が連続しないようスコア減衰                              │    │   │
│   │   │   - 2回目以降の同一著者: スコア × 0.5                                   │    │   │
│   │   │   - 3回目以降: スコア × 0.25 ...                                        │    │   │
│   │   │                                                                        │    │   │
│   │   └────────────────────────────────────────────────────────────────────────┘    │   │
│   │                                        │                                        │   │
│   │                                        ▼                                        │   │
│   │   ┌────────────────────────────────────────────────────────────────────────┐    │   │
│   │   │                          OON SCORER                                     │    │   │
│   │   │                                                                        │    │   │
│   │   │   Out-of-Network コンテンツのスコア調整                                 │    │   │
│   │   │   - in_network: false の場合に適用                                     │    │   │
│   │   │   - フィード多様性のための調整係数                                      │    │   │
│   │   │                                                                        │    │   │
│   │   └────────────────────────────────────────────────────────────────────────┘    │   │
│   │                                                                                 │   │
│   └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
│   Output: Vec<PostCandidate> with score: Option<f64>                                    │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

**PhoenixScores データ構造**:

```rust
pub struct PhoenixScores {
    pub favorite_score: Option<f64>,
    pub reply_score: Option<f64>,
    pub retweet_score: Option<f64>,
    pub photo_expand_score: Option<f64>,
    pub click_score: Option<f64>,
    pub profile_click_score: Option<f64>,
    pub vqv_score: Option<f64>,
    pub share_score: Option<f64>,
    pub share_via_dm_score: Option<f64>,
    pub share_via_copy_link_score: Option<f64>,
    pub dwell_score: Option<f64>,
    pub quote_score: Option<f64>,
    pub quoted_click_score: Option<f64>,
    pub follow_author_score: Option<f64>,
    pub not_interested_score: Option<f64>,
    pub block_author_score: Option<f64>,
    pub mute_author_score: Option<f64>,
    pub report_score: Option<f64>,
    pub dwell_time: Option<f64>,
}
```

### 3.6 Stage 6: Selection

**目的**: スコア順にソートし、上位K件を選択

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                 SELECTION STAGE                                          │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   Input: Vec<PostCandidate> (scored)                                                    │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│   │                         TOP-K SCORE SELECTOR                                     │   │
│   │                                                                                 │   │
│   │   Algorithm:                                                                    │   │
│   │   1. candidates.sort_by(|a, b| b.score.cmp(&a.score))  // 降順ソート            │   │
│   │   2. candidates.truncate(K)                            // 上位K件に切り詰め     │   │
│   │                                                                                 │   │
│   │   K = params::RESULT_SIZE (設定可能)                                            │   │
│   │                                                                                 │   │
│   │   ┌────────────────────────────────────────────────────────────────────────┐    │   │
│   │   │  Score Distribution (example):                                          │    │   │
│   │   │                                                                        │    │   │
│   │   │  Candidate 1: 0.95  ←── Selected                                       │    │   │
│   │   │  Candidate 2: 0.87  ←── Selected                                       │    │   │
│   │   │  Candidate 3: 0.82  ←── Selected                                       │    │   │
│   │   │  ...                                                                   │    │   │
│   │   │  Candidate K: 0.45  ←── Selected (cutoff)                              │    │   │
│   │   │  ─────────────────────────────────────────                             │    │   │
│   │   │  Candidate K+1: 0.44  ✗ Not selected                                   │    │   │
│   │   │  ...                                                                   │    │   │
│   │   └────────────────────────────────────────────────────────────────────────┘    │   │
│   │                                                                                 │   │
│   └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
│   Output: Vec<PostCandidate> (top K candidates)                                         │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 3.7 Stage 7: Post-Selection Processing

**目的**: 選択後の最終検証とフィルタリング

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           POST-SELECTION PROCESSING STAGE                                │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   Input: Vec<PostCandidate> (selected top K)                                            │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│   │                      POST-SELECTION HYDRATORS                                    │   │
│   │                                                                                 │   │
│   │   ┌────────────────────────────────────────────────────────────────────────┐    │   │
│   │   │                    VF CANDIDATE HYDRATOR                                │    │   │
│   │   │                                                                        │    │   │
│   │   │   VisibilityFilteringClient からデータ取得:                            │    │   │
│   │   │   - 投稿の可視性状態                                                   │    │   │
│   │   │   - 削除/スパム/ポリシー違反フラグ                                     │    │   │
│   │   │   - visibility_reason の設定                                           │    │   │
│   │   │                                                                        │    │   │
│   │   └────────────────────────────────────────────────────────────────────────┘    │   │
│   │                                                                                 │   │
│   └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                                │
│                                        ▼                                                │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│   │                      POST-SELECTION FILTERS                                      │   │
│   │                                                                                 │   │
│   │   ┌────────────────────────────────────────────────────────────────────────┐    │   │
│   │   │                         VF FILTER                                       │    │   │
│   │   │                                                                        │    │   │
│   │   │   除外対象:                                                             │    │   │
│   │   │   - 削除された投稿                                                      │    │   │
│   │   │   - スパム判定された投稿                                                │    │   │
│   │   │   - 暴力/ゴア含むコンテンツ                                             │    │   │
│   │   │   - その他ポリシー違反コンテンツ                                        │    │   │
│   │   │                                                                        │    │   │
│   │   └────────────────────────────────────────────────────────────────────────┘    │   │
│   │              │                                                                  │   │
│   │              ▼                                                                  │   │
│   │   ┌────────────────────────────────────────────────────────────────────────┐    │   │
│   │   │                  DEDUP CONVERSATION FILTER                              │    │   │
│   │   │                                                                        │    │   │
│   │   │   同一会話スレッドからの複数分岐を重複排除:                             │    │   │
│   │   │   - conversation_id で グループ化                                       │    │   │
│   │   │   - 各会話から最高スコアの投稿のみ保持                                  │    │   │
│   │   │                                                                        │    │   │
│   │   └────────────────────────────────────────────────────────────────────────┘    │   │
│   │                                                                                 │   │
│   └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                                │
│                                        ▼                                                │
│                              final_candidates.truncate(RESULT_SIZE)                     │
│                                                                                         │
│   Output: Vec<PostCandidate> (final feed)                                               │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 3.8 Stage 8: Side Effects

**目的**: 非同期の副作用処理（キャッシュ、ロギング等）

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                SIDE EFFECTS STAGE                                        │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   Input: SideEffectInput { query, selected_candidates }                                 │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│   │                   ASYNC PARALLEL SIDE EFFECTS                                    │   │
│   │                                                                                 │   │
│   │   tokio::spawn(async move {                                                     │   │
│   │       join_all(side_effects.map(|se| se.run(input)))                           │   │
│   │   });                                                                          │   │
│   │                                                                                 │   │
│   │   ┌────────────────────────────────────────────────────────────────────────┐    │   │
│   │   │              CACHE REQUEST INFO SIDE EFFECT                             │    │   │
│   │   │                                                                        │    │   │
│   │   │   Strato Client を使用してリクエスト情報をキャッシュ:                   │    │   │
│   │   │                                                                        │    │   │
│   │   │   キャッシュ内容:                                                       │    │   │
│   │   │   - request_id                                                         │    │   │
│   │   │   - user_id                                                            │    │   │
│   │   │   - served_tweet_ids                                                   │    │   │
│   │   │   - timestamp                                                          │    │   │
│   │   │                                                                        │    │   │
│   │   │   用途:                                                                 │    │   │
│   │   │   - PreviouslyServedPostsFilter で参照                                 │    │   │
│   │   │   - A/Bテスト分析                                                       │    │   │
│   │   │   - デバッグ/モニタリング                                              │    │   │
│   │   │                                                                        │    │   │
│   │   └────────────────────────────────────────────────────────────────────────┘    │   │
│   │                                                                                 │   │
│   └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
│   Note: Side Effects はレスポンスをブロックしない (fire-and-forget)                     │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. gRPCサービス構成

### 4.1 サービス一覧

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              gRPC SERVICE ARCHITECTURE                                   │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│   │                             HOME MIXER SERVICE                                   │   │
│   │                                                                                 │   │
│   │   Service: ScoredPostsService                                                   │   │
│   │   Port: 50051 (default)                                                         │   │
│   │                                                                                 │   │
│   │   ┌─────────────────────────────────────────────────────────────────────────┐   │   │
│   │   │  RPC: GetScoredPosts                                                     │   │   │
│   │   │                                                                         │   │   │
│   │   │  Request: ScoredPostsQuery                                              │   │   │
│   │   │  ├── viewer_id: uint64                                                  │   │   │
│   │   │  ├── client_app_id: int32                                               │   │   │
│   │   │  ├── country_code: string                                               │   │   │
│   │   │  ├── language_code: string                                              │   │   │
│   │   │  ├── seen_ids: repeated int64                                           │   │   │
│   │   │  ├── served_ids: repeated int64                                         │   │   │
│   │   │  ├── in_network_only: bool                                              │   │   │
│   │   │  ├── is_bottom_request: bool                                            │   │   │
│   │   │  └── bloom_filter_entries: repeated ImpressionBloomFilterEntry          │   │   │
│   │   │                                                                         │   │   │
│   │   │  Response: ScoredPostsResponse                                          │   │   │
│   │   │  └── scored_posts: repeated ScoredPost                                  │   │   │
│   │   │      ├── tweet_id: uint64                                               │   │   │
│   │   │      ├── author_id: uint64                                              │   │   │
│   │   │      ├── retweeted_tweet_id: uint64                                     │   │   │
│   │   │      ├── retweeted_user_id: uint64                                      │   │   │
│   │   │      ├── in_reply_to_tweet_id: uint64                                   │   │   │
│   │   │      ├── score: float                                                   │   │   │
│   │   │      ├── in_network: bool                                               │   │   │
│   │   │      ├── served_type: ServedType                                        │   │   │
│   │   │      ├── last_scored_timestamp_ms: uint64                               │   │   │
│   │   │      ├── prediction_request_id: uint64                                  │   │   │
│   │   │      ├── ancestors: repeated uint64                                     │   │   │
│   │   │      ├── screen_names: map<uint64, string>                              │   │   │
│   │   │      └── visibility_reason: VisibilityReason                            │   │   │
│   │   │                                                                         │   │   │
│   │   └─────────────────────────────────────────────────────────────────────────┘   │   │
│   │                                                                                 │   │
│   └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│   │                             THUNDER SERVICE                                      │   │
│   │                                                                                 │   │
│   │   Service: InNetworkPostsService                                                │   │
│   │   Port: 50052 (default)                                                         │   │
│   │   Compression: Zstd                                                             │   │
│   │                                                                                 │   │
│   │   ┌─────────────────────────────────────────────────────────────────────────┐   │   │
│   │   │  RPC: GetInNetworkPosts                                                  │   │   │
│   │   │                                                                         │   │   │
│   │   │  Request: GetInNetworkPostsRequest                                      │   │   │
│   │   │  ├── user_id: uint64                                                    │   │   │
│   │   │  ├── following_user_ids: repeated uint64                                │   │   │
│   │   │  ├── exclude_tweet_ids: repeated uint64                                 │   │   │
│   │   │  ├── max_results: int32                                                 │   │   │
│   │   │  ├── is_video_request: bool                                             │   │   │
│   │   │  └── debug: bool                                                        │   │   │
│   │   │                                                                         │   │   │
│   │   │  Response: GetInNetworkPostsResponse                                    │   │   │
│   │   │  └── posts: repeated LightPost                                          │   │   │
│   │   │      ├── post_id: int64                                                 │   │   │
│   │   │      ├── author_id: int64                                               │   │   │
│   │   │      ├── created_at: int64 (timestamp)                                  │   │   │
│   │   │      ├── is_reply: bool                                                 │   │   │
│   │   │      ├── is_retweet: bool                                               │   │   │
│   │   │      ├── has_video: bool                                                │   │   │
│   │   │      ├── source_post_id: optional int64                                 │   │   │
│   │   │      ├── source_user_id: optional int64                                 │   │   │
│   │   │      ├── in_reply_to_post_id: optional int64                            │   │   │
│   │   │      ├── in_reply_to_user_id: optional int64                            │   │   │
│   │   │      └── conversation_id: optional int64                                │   │   │
│   │   │                                                                         │   │   │
│   │   └─────────────────────────────────────────────────────────────────────────┘   │   │
│   │                                                                                 │   │
│   └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│   │                        PHOENIX PREDICTION SERVICE                                │   │
│   │                                                                                 │   │
│   │   Service: PhoenixPredictionService                                             │   │
│   │   Port: 50053 (default)                                                         │   │
│   │                                                                                 │   │
│   │   RPC: Predict                                                                  │   │
│   │   - User action sequence + candidates → engagement probabilities                │   │
│   │                                                                                 │   │
│   └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│   │                        PHOENIX RETRIEVAL SERVICE                                 │   │
│   │                                                                                 │   │
│   │   Service: PhoenixRetrievalService                                              │   │
│   │   Port: 50054 (default)                                                         │   │
│   │                                                                                 │   │
│   │   RPC: Retrieve                                                                 │   │
│   │   - User features → top-K out-of-network candidates                            │   │
│   │                                                                                 │   │
│   └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 外部サービス依存関係

| サービス名 | 役割 | 使用コンポーネント |
|-----------|------|-------------------|
| **Gizmoduck** | ユーザープロフィール情報 | GizmoduckCandidateHydrator |
| **TES (Tweet Entity Service)** | ツイートメタデータ | CoreDataCandidateHydrator, etc. |
| **Strato** | KVストア/設定 | UserFeaturesQueryHydrator, CacheSideEffect |
| **SocialGraph** | フォロー/ブロック関係 | AuthorSocialgraphFilter |
| **VisibilityFiltering** | コンテンツ可視性 | VFFilter |
| **UAS** | ユーザーアクション履歴 | UserActionSeqQueryHydrator |

---

## 5. データモデルとスキーマ

### 5.1 主要データ構造

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                DATA MODEL OVERVIEW                                       │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│   │                            ScoredPostsQuery                                      │   │
│   │                         (パイプライン入力クエリ)                                 │   │
│   ├─────────────────────────────────────────────────────────────────────────────────┤   │
│   │                                                                                 │   │
│   │   Core Fields:                                                                  │   │
│   │   ├── user_id: i64                     // リクエストユーザーID                  │   │
│   │   ├── client_app_id: i32               // クライアントアプリ識別子              │   │
│   │   ├── country_code: String             // 国コード (ISO 3166-1)                │   │
│   │   ├── language_code: String            // 言語コード (ISO 639-1)               │   │
│   │   ├── seen_ids: Vec<i64>               // 既読投稿ID                           │   │
│   │   ├── served_ids: Vec<i64>             // 既配信投稿ID                         │   │
│   │   ├── in_network_only: bool            // インネットワーク限定フラグ           │   │
│   │   ├── is_bottom_request: bool          // ページネーションフラグ               │   │
│   │   └── bloom_filter_entries: Vec<...>   // インプレッションブルームフィルタ     │   │
│   │                                                                                 │   │
│   │   Hydrated Fields:                                                              │   │
│   │   ├── user_action_sequence: Option<UserActionSequence>                          │   │
│   │   │   └── 過去のエンゲージメント履歴 (いいね、RT、クリック等)                   │   │
│   │   ├── user_features: UserFeatures                                               │   │
│   │   │   ├── following_list: Vec<i64>                                             │   │
│   │   │   ├── muted_keywords: Vec<String>                                          │   │
│   │   │   └── blocked_users: Vec<i64>                                              │   │
│   │   └── request_id: String               // トレーシング用リクエストID           │   │
│   │                                                                                 │   │
│   └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│   │                             PostCandidate                                        │   │
│   │                            (候補投稿データ)                                      │   │
│   ├─────────────────────────────────────────────────────────────────────────────────┤   │
│   │                                                                                 │   │
│   │   Identity:                                                                     │   │
│   │   ├── tweet_id: i64                    // 投稿ID                               │   │
│   │   └── author_id: u64                   // 著者ユーザーID                       │   │
│   │                                                                                 │   │
│   │   Content:                                                                      │   │
│   │   ├── tweet_text: String               // 投稿テキスト                         │   │
│   │   ├── in_reply_to_tweet_id: Option<u64>// リプライ先投稿ID                     │   │
│   │   ├── retweeted_tweet_id: Option<u64>  // リツイート元投稿ID                   │   │
│   │   ├── retweeted_user_id: Option<u64>   // リツイート元ユーザーID               │   │
│   │   ├── ancestors: Vec<u64>              // 会話の祖先投稿ID                     │   │
│   │   └── video_duration_ms: Option<i32>   // 動画長 (ミリ秒)                      │   │
│   │                                                                                 │   │
│   │   Author Info:                                                                  │   │
│   │   ├── author_followers_count: Option<i32>                                       │   │
│   │   ├── author_screen_name: Option<String>                                        │   │
│   │   └── retweeted_screen_name: Option<String>                                     │   │
│   │                                                                                 │   │
│   │   Scores:                                                                       │   │
│   │   ├── phoenix_scores: PhoenixScores    // ML予測スコア群                       │   │
│   │   ├── weighted_score: Option<f64>      // 重み付き合計スコア                   │   │
│   │   └── score: Option<f64>               // 最終スコア                           │   │
│   │                                                                                 │   │
│   │   Metadata:                                                                     │   │
│   │   ├── prediction_request_id: Option<u64>                                        │   │
│   │   ├── last_scored_at_ms: Option<u64>                                            │   │
│   │   ├── served_type: Option<ServedType>                                           │   │
│   │   ├── in_network: Option<bool>         // インネットワークフラグ               │   │
│   │   ├── visibility_reason: Option<FilteredReason>                                 │   │
│   │   └── subscription_author_id: Option<u64>                                       │   │
│   │                                                                                 │   │
│   └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│   │                             PhoenixScores                                        │   │
│   │                          (ML予測スコア群)                                        │   │
│   ├─────────────────────────────────────────────────────────────────────────────────┤   │
│   │                                                                                 │   │
│   │   Positive Engagement Predictions:                                              │   │
│   │   ├── favorite_score: Option<f64>      // P(いいね)                            │   │
│   │   ├── reply_score: Option<f64>         // P(リプライ)                          │   │
│   │   ├── retweet_score: Option<f64>       // P(リツイート)                        │   │
│   │   ├── quote_score: Option<f64>         // P(引用RT)                            │   │
│   │   ├── click_score: Option<f64>         // P(クリック)                          │   │
│   │   ├── profile_click_score: Option<f64> // P(プロフィールクリック)              │   │
│   │   ├── photo_expand_score: Option<f64>  // P(画像拡大)                          │   │
│   │   ├── vqv_score: Option<f64>           // P(動画視聴)                          │   │
│   │   ├── share_score: Option<f64>         // P(シェア)                            │   │
│   │   ├── share_via_dm_score: Option<f64>  // P(DMシェア)                          │   │
│   │   ├── share_via_copy_link_score: Option<f64> // P(リンクコピー)                │   │
│   │   ├── dwell_score: Option<f64>         // P(滞在)                              │   │
│   │   ├── quoted_click_score: Option<f64>  // P(引用RTクリック)                    │   │
│   │   ├── follow_author_score: Option<f64> // P(著者フォロー)                      │   │
│   │   └── dwell_time: Option<f64>          // 予測滞在時間                         │   │
│   │                                                                                 │   │
│   │   Negative Engagement Predictions:                                              │   │
│   │   ├── not_interested_score: Option<f64>// P(興味なし)                          │   │
│   │   ├── block_author_score: Option<f64>  // P(著者ブロック)                      │   │
│   │   ├── mute_author_score: Option<f64>   // P(著者ミュート)                      │   │
│   │   └── report_score: Option<f64>        // P(通報)                              │   │
│   │                                                                                 │   │
│   └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│   │                               LightPost                                          │   │
│   │                       (Thunder用軽量投稿データ)                                  │   │
│   ├─────────────────────────────────────────────────────────────────────────────────┤   │
│   │                                                                                 │   │
│   │   ├── post_id: i64                     // 投稿ID                               │   │
│   │   ├── author_id: i64                   // 著者ID                               │   │
│   │   ├── created_at: i64                  // 作成タイムスタンプ                   │   │
│   │   ├── is_reply: bool                   // リプライフラグ                       │   │
│   │   ├── is_retweet: bool                 // リツイートフラグ                     │   │
│   │   ├── has_video: bool                  // 動画含有フラグ                       │   │
│   │   ├── source_post_id: Option<i64>      // RT元投稿ID                           │   │
│   │   ├── source_user_id: Option<i64>      // RT元ユーザーID                       │   │
│   │   ├── in_reply_to_post_id: Option<i64> // リプライ先投稿ID                     │   │
│   │   ├── in_reply_to_user_id: Option<i64> // リプライ先ユーザーID                 │   │
│   │   └── conversation_id: Option<i64>     // 会話ID                               │   │
│   │                                                                                 │   │
│   └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 ML モデル入力データ構造

```python
# RecsysBatch: モデル入力バッチ
class RecsysBatch(NamedTuple):
    user_hashes: jax.Array              # [B, num_user_hashes]
    history_post_hashes: jax.Array      # [B, S, num_item_hashes]
    history_author_hashes: jax.Array    # [B, S, num_author_hashes]
    history_actions: jax.Array          # [B, S, num_actions] (multi-hot)
    history_product_surface: jax.Array  # [B, S]
    candidate_post_hashes: jax.Array    # [B, C, num_item_hashes]
    candidate_author_hashes: jax.Array  # [B, C, num_author_hashes]
    candidate_product_surface: jax.Array # [B, C]

# RecsysEmbeddings: 事前ルックアップ済み埋め込み
class RecsysEmbeddings(NamedTuple):
    user_embeddings: jax.Array          # [B, num_user_hashes, D]
    history_post_embeddings: jax.Array  # [B, S, num_item_hashes, D]
    candidate_post_embeddings: jax.Array # [B, C, num_item_hashes, D]
    history_author_embeddings: jax.Array # [B, S, num_author_hashes, D]
    candidate_author_embeddings: jax.Array # [B, C, num_author_hashes, D]
```

---

## 6. コンポーネント間の通信フロー

### 6.1 リクエストフロー詳細

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              REQUEST FLOW SEQUENCE                                       │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   Client                Home Mixer         Thunder          Phoenix         External    │
│     │                       │                │                │               │         │
│     │  1. GetScoredPosts    │                │                │               │         │
│     │ ───────────────────▶  │                │                │               │         │
│     │                       │                │                │               │         │
│     │                       │  2a. Query Hydration (parallel)                │         │
│     │                       │ ───────────────────────────────────────────────▶│         │
│     │                       │   - UAS Fetcher (user action sequence)         │         │
│     │                       │   - Strato (user features)                     │         │
│     │                       │ ◀───────────────────────────────────────────────│         │
│     │                       │                │                │               │         │
│     │                       │  2b. Candidate Sources (parallel)              │         │
│     │                       │                │                │               │         │
│     │                       │  GetInNetwork  │                │               │         │
│     │                       │ ──────────────▶│                │               │         │
│     │                       │                │                │               │         │
│     │                       │  LightPosts    │                │               │         │
│     │                       │ ◀──────────────│                │               │         │
│     │                       │                │                │               │         │
│     │                       │                │    Retrieve    │               │         │
│     │                       │ ───────────────────────────────▶│               │         │
│     │                       │                │                │               │         │
│     │                       │                │   Candidates   │               │         │
│     │                       │ ◀───────────────────────────────│               │         │
│     │                       │                │                │               │         │
│     │                       │  3. Hydration (parallel)                       │         │
│     │                       │ ───────────────────────────────────────────────▶│         │
│     │                       │   - TES (core data, video, subscription)       │         │
│     │                       │   - Gizmoduck (author info)                    │         │
│     │                       │ ◀───────────────────────────────────────────────│         │
│     │                       │                │                │               │         │
│     │                       │  4. Pre-Scoring Filters (sequential)           │         │
│     │                       │   [Internal processing - no external calls]    │         │
│     │                       │                │                │               │         │
│     │                       │  5. Scoring                     │               │         │
│     │                       │                │    Predict     │               │         │
│     │                       │ ───────────────────────────────▶│               │         │
│     │                       │                │                │               │         │
│     │                       │                │  PhoenixScores │               │         │
│     │                       │ ◀───────────────────────────────│               │         │
│     │                       │                │                │               │         │
│     │                       │   [WeightedScorer, AuthorDiversityScorer,      │         │
│     │                       │    OONScorer - internal processing]            │         │
│     │                       │                │                │               │         │
│     │                       │  6. Selection                                   │         │
│     │                       │   [Internal: sort + truncate]                   │         │
│     │                       │                │                │               │         │
│     │                       │  7. Post-Selection                             │         │
│     │                       │ ───────────────────────────────────────────────▶│         │
│     │                       │   - VF Client (visibility filtering)           │         │
│     │                       │ ◀───────────────────────────────────────────────│         │
│     │                       │                │                │               │         │
│     │                       │  8. Side Effects (async, non-blocking)         │         │
│     │                       │ ···············································▶│         │
│     │                       │   - Strato (cache request info)                │         │
│     │                       │                │                │               │         │
│     │  ScoredPostsResponse  │                │                │               │         │
│     │ ◀─────────────────────│                │                │               │         │
│     │                       │                │                │               │         │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 Thunder データ取り込みフロー

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           THUNDER DATA INGESTION FLOW                                    │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   Kafka                    Thunder Service                   PostStore                  │
│     │                           │                               │                       │
│     │   TweetCreateEvent        │                               │                       │
│     │ ─────────────────────────▶│                               │                       │
│     │                           │                               │                       │
│     │                           │   insert_posts(LightPost)     │                       │
│     │                           │ ─────────────────────────────▶│                       │
│     │                           │                               │                       │
│     │                           │                               │  ┌──────────────────┐ │
│     │                           │                               │  │ posts DashMap    │ │
│     │                           │                               │  │ (post_id → data) │ │
│     │                           │                               │  └──────────────────┘ │
│     │                           │                               │                       │
│     │                           │                               │  ┌──────────────────┐ │
│     │                           │                               │  │ posts_by_user    │ │
│     │                           │                               │  │ (user_id → deque)│ │
│     │                           │                               │  └──────────────────┘ │
│     │                           │                               │                       │
│     │   TweetDeleteEvent        │                               │                       │
│     │ ─────────────────────────▶│                               │                       │
│     │                           │                               │                       │
│     │                           │   mark_as_deleted(post_id)    │                       │
│     │                           │ ─────────────────────────────▶│                       │
│     │                           │                               │                       │
│     │                           │                               │  ┌──────────────────┐ │
│     │                           │                               │  │ deleted_posts    │ │
│     │                           │                               │  │ DashMap          │ │
│     │                           │                               │  └──────────────────┘ │
│     │                           │                               │                       │
│     │                           │        Auto-Trim (periodic)   │                       │
│     │                           │                               │                       │
│     │                           │   trim_old_posts()            │                       │
│     │                           │ ─────────────────────────────▶│                       │
│     │                           │                               │                       │
│     │                           │                               │   retention_seconds   │
│     │                           │                               │   より古い投稿を削除   │
│     │                           │                               │                       │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. MLモデルアーキテクチャ

### 7.1 Phoenix Ranking Model

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                            PHOENIX RANKING MODEL ARCHITECTURE                            │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│                                    OUTPUT LOGITS                                        │
│                              [B, num_candidates, num_actions]                           │
│                                         │                                               │
│                                         │ Linear Projection (unembedding)               │
│                                         │ [D] → [num_actions]                           │
│                                         │                                               │
│                         ┌───────────────┴───────────────┐                               │
│                         │     Layer Normalization        │                               │
│                         └───────────────┬───────────────┘                               │
│                                         │                                               │
│                         ┌───────────────┴───────────────┐                               │
│                         │  Extract Candidate Outputs     │                               │
│                         │  [:, candidate_start_offset:, :]│                              │
│                         └───────────────┬───────────────┘                               │
│                                         │                                               │
│   ┌─────────────────────────────────────┴─────────────────────────────────────┐         │
│   │                                                                           │         │
│   │                    GROK TRANSFORMER (N layers)                            │         │
│   │                                                                           │         │
│   │   ┌─────────────────────────────────────────────────────────────────┐     │         │
│   │   │                     DECODER LAYER × N                            │     │         │
│   │   │                                                                 │     │         │
│   │   │   ┌─────────────────────────────────────────────────────────┐   │     │         │
│   │   │   │              MULTI-HEAD ATTENTION                        │   │     │         │
│   │   │   │                                                         │   │     │         │
│   │   │   │   - num_q_heads: Query ヘッド数                          │   │     │         │
│   │   │   │   - num_kv_heads: Key/Value ヘッド数 (GQA対応)           │   │     │         │
│   │   │   │   - key_size: Attention次元                             │   │     │         │
│   │   │   │   - Rotary Position Embedding (RoPE)                    │   │     │         │
│   │   │   │   - Candidate Isolation Attention Mask                  │   │     │         │
│   │   │   │                                                         │   │     │         │
│   │   │   └─────────────────────────────────────────────────────────┘   │     │         │
│   │   │                           │                                     │     │         │
│   │   │                           ▼                                     │     │         │
│   │   │   ┌─────────────────────────────────────────────────────────┐   │     │         │
│   │   │   │              DENSE BLOCK (FFN)                           │   │     │         │
│   │   │   │                                                         │   │     │         │
│   │   │   │   - Linear V: [D] → [ffn_size]                          │   │     │         │
│   │   │   │   - Linear W1 + GELU: [D] → [ffn_size]                  │   │     │         │
│   │   │   │   - Element-wise multiply: h_v * h_w1                   │   │     │         │
│   │   │   │   - Linear: [ffn_size] → [D]                            │   │     │         │
│   │   │   │                                                         │   │     │         │
│   │   │   └─────────────────────────────────────────────────────────┘   │     │         │
│   │   │                                                                 │     │         │
│   │   │   RMSNorm + Residual connections throughout                     │     │         │
│   │   │                                                                 │     │         │
│   │   └─────────────────────────────────────────────────────────────────┘     │         │
│   │                                                                           │         │
│   └───────────────────────────────────────────────────────────────────────────┘         │
│                                         │                                               │
│                                         │                                               │
│   ┌─────────────────────────────────────┴─────────────────────────────────────┐         │
│   │                          INPUT CONSTRUCTION                               │         │
│   │                                                                           │         │
│   │   Concatenate: [User Embedding] [History Embeddings] [Candidate Embeddings]│        │
│   │                     [1, D]         [S, D]              [C, D]             │         │
│   │                                                                           │         │
│   └───────────────────────────────────────────────────────────────────────────┘         │
│           │                       │                           │                         │
│           ▼                       ▼                           ▼                         │
│   ┌───────────────┐      ┌───────────────┐           ┌───────────────┐                 │
│   │ block_user_   │      │ block_history_│           │ block_candidate│                 │
│   │ reduce        │      │ reduce        │           │ _reduce       │                 │
│   │               │      │               │           │               │                 │
│   │ user_hashes   │      │ post_hashes   │           │ post_hashes   │                 │
│   │ → projection  │      │ author_hashes │           │ author_hashes │                 │
│   │ → [1, D]      │      │ actions       │           │ product_surface│                │
│   │               │      │ product_surface│          │ → projection  │                 │
│   │               │      │ → projection  │           │ → [C, D]      │                 │
│   │               │      │ → [S, D]      │           │               │                 │
│   └───────────────┘      └───────────────┘           └───────────────┘                 │
│           │                       │                           │                         │
│           ▼                       ▼                           ▼                         │
│   ┌───────────────────────────────────────────────────────────────────────────┐         │
│   │                       HASH-BASED EMBEDDINGS                               │         │
│   │                                                                           │         │
│   │   Multiple hash functions per entity → embedding lookup → concat → project│        │
│   │                                                                           │         │
│   │   user_embeddings: [B, num_user_hashes, D]                               │         │
│   │   post_embeddings: [B, seq_len, num_item_hashes, D]                      │         │
│   │   author_embeddings: [B, seq_len, num_author_hashes, D]                  │         │
│   │                                                                           │         │
│   └───────────────────────────────────────────────────────────────────────────┘         │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 Phoenix Retrieval Model (Two-Tower)

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                         PHOENIX RETRIEVAL MODEL ARCHITECTURE                             │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│                                   TOP-K RETRIEVAL                                       │
│                              ┌───────────────────────────┐                              │
│                              │   top_k_indices: [B, K]   │                              │
│                              │   top_k_scores: [B, K]    │                              │
│                              └───────────────┬───────────┘                              │
│                                              │                                          │
│                                              │ jax.lax.top_k                            │
│                                              │                                          │
│                              ┌───────────────┴───────────┐                              │
│                              │   SIMILARITY SCORES        │                              │
│                              │   [B, N] = dot(user, corpus.T) │                         │
│                              └───────────────┬───────────┘                              │
│                                              │                                          │
│                     ┌────────────────────────┴────────────────────────┐                 │
│                     │                                                │                 │
│                     ▼                                                ▼                 │
│   ┌─────────────────────────────────────┐      ┌─────────────────────────────────────┐ │
│   │           USER TOWER                 │      │       CANDIDATE TOWER               │ │
│   │                                     │      │                                     │ │
│   │   Output: user_representation       │      │   Output: corpus_embeddings         │ │
│   │           [B, D] (L2-normalized)    │      │           [N, D] (L2-normalized)    │ │
│   │                                     │      │                                     │ │
│   │   ┌─────────────────────────────┐   │      │   ┌─────────────────────────────┐   │ │
│   │   │      L2 Normalization        │   │      │   │      L2 Normalization        │   │ │
│   │   └─────────────┬───────────────┘   │      │   └─────────────┬───────────────┘   │ │
│   │                 │                   │      │                 │                   │ │
│   │   ┌─────────────┴───────────────┐   │      │   ┌─────────────┴───────────────┐   │ │
│   │   │      Mean Pooling            │   │      │   │      MLP Projection         │   │ │
│   │   │   (over valid positions)     │   │      │   │   (2-layer with SiLU)       │   │ │
│   │   └─────────────┬───────────────┘   │      │   │                             │   │ │
│   │                 │                   │      │   │   Linear1: [concat] → [2D]   │   │ │
│   │   ┌─────────────┴───────────────┐   │      │   │   SiLU activation           │   │ │
│   │   │   GROK TRANSFORMER           │   │      │   │   Linear2: [2D] → [D]       │   │ │
│   │   │                             │   │      │   │                             │   │ │
│   │   │   Same architecture as      │   │      │   └─────────────┬───────────────┘   │ │
│   │   │   ranking model but         │   │      │                 │                   │ │
│   │   │   without candidate isolation│  │      │   ┌─────────────┴───────────────┐   │ │
│   │   │                             │   │      │   │      Concatenate             │   │ │
│   │   └─────────────┬───────────────┘   │      │   │   post_emb + author_emb      │   │ │
│   │                 │                   │      │   └─────────────┬───────────────┘   │ │
│   │   ┌─────────────┴───────────────┐   │      │                 │                   │ │
│   │   │      Input Embeddings        │   │      │   ┌─────────────┴───────────────┐   │ │
│   │   │                             │   │      │   │      Hash Embeddings         │   │ │
│   │   │   [User] [History...]        │   │      │   │                             │   │ │
│   │   │                             │   │      │   │   candidate_post_hashes      │   │ │
│   │   │   user_embeddings           │   │      │   │   candidate_author_hashes    │   │ │
│   │   │   history_post_embeddings   │   │      │   │                             │   │ │
│   │   │   history_author_embeddings │   │      │   └─────────────────────────────┘   │ │
│   │   │   history_actions_embeddings│   │      │                                     │ │
│   │   │   product_surface_embeddings│   │      │                                     │ │
│   │   └─────────────────────────────┘   │      │                                     │ │
│   │                                     │      │                                     │ │
│   └─────────────────────────────────────┘      └─────────────────────────────────────┘ │
│                                                                                         │
│   Usage:                                                                                │
│   - User Tower: オンラインでリアルタイム計算                                            │
│   - Candidate Tower: オフラインで事前計算、コーパスとしてインデックス化                 │
│   - Retrieval: dot product → ANN search (FAISS, ScaNN, etc.)                           │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 7.3 Candidate Isolation Attention Mask

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                        CANDIDATE ISOLATION ATTENTION MASK                                │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   Key: ✓ = Can attend (1.0)    ✗ = Cannot attend (0.0)                                 │
│                                                                                         │
│                               Keys (what we attend TO)                                  │
│               ────────────────────────────────────────────────────────▶                │
│                                                                                         │
│              │ User │    History (S positions)    │   Candidates (C positions)    │    │
│         ┌────┼──────┼─────────────────────────────┼───────────────────────────────┤    │
│         │    │      │                             │                               │    │
│         │ U  │  ✓   │  ✓   ✓   ✓   ✓   ✓   ✓   ✓  │  ✗   ✗   ✗   ✗   ✗   ✗   ✗    │    │
│         │    │      │                             │                               │    │
│         ├────┼──────┼─────────────────────────────┼───────────────────────────────┤    │
│      Q  │    │      │                             │                               │    │
│      u  │ H  │  ✓   │  ✓   ✓   ✓   ✓   ✓   ✓   ✓  │  ✗   ✗   ✗   ✗   ✗   ✗   ✗    │    │
│      e  │ i  │  ✓   │  ✓   ✓   ✓   ✓   ✓   ✓   ✓  │  ✗   ✗   ✗   ✗   ✗   ✗   ✗    │    │
│      r  │ s  │  ✓   │  ✓   ✓   ✓   ✓   ✓   ✓   ✓  │  ✗   ✗   ✗   ✗   ✗   ✗   ✗    │    │
│      i  │ t  │  ✓   │  ✓   ✓   ✓   ✓   ✓   ✓   ✓  │  ✗   ✗   ✗   ✗   ✗   ✗   ✗    │    │
│      e  │    │      │                             │                               │    │
│      s  ├────┼──────┼─────────────────────────────┼───────────────────────────────┤    │
│         │    │      │                             │  DIAGONAL ONLY (self-attend)  │    │
│      │  │ C  │  ✓   │  ✓   ✓   ✓   ✓   ✓   ✓   ✓  │  ✓   ✗   ✗   ✗   ✗   ✗   ✗    │    │
│      │  │ a  │  ✓   │  ✓   ✓   ✓   ✓   ✓   ✓   ✓  │  ✗   ✓   ✗   ✗   ✗   ✗   ✗    │    │
│      │  │ n  │  ✓   │  ✓   ✓   ✓   ✓   ✓   ✓   ✓  │  ✗   ✗   ✓   ✗   ✗   ✗   ✗    │    │
│      │  │ d  │  ✓   │  ✓   ✓   ✓   ✓   ✓   ✓   ✓  │  ✗   ✗   ✗   ✓   ✗   ✗   ✗    │    │
│      │  │ i  │  ✓   │  ✓   ✓   ✓   ✓   ✓   ✓   ✓  │  ✗   ✗   ✗   ✗   ✓   ✗   ✗    │    │
│      │  │ d  │  ✓   │  ✓   ✓   ✓   ✓   ✓   ✓   ✓  │  ✗   ✗   ✗   ✗   ✗   ✓   ✗    │    │
│      ▼  │ s  │  ✓   │  ✓   ✓   ✓   ✓   ✓   ✓   ✓  │  ✗   ✗   ✗   ✗   ✗   ✗   ✓    │    │
│         │    │      │                             │                               │    │
│         └────┴──────┴─────────────────────────────┴───────────────────────────────┘    │
│                                                                                         │
│   Properties:                                                                           │
│   ├─ User + History: 双方向アテンション (互いに参照可能)                               │
│   ├─ Candidates → User/History: 候補はユーザーコンテキストを参照可能                   │
│   └─ Candidates → Candidates: 候補間は互いに参照不可 (自己参照のみ)                    │
│                                                                                         │
│   Benefits:                                                                             │
│   ├─ スコアの一貫性: 候補のスコアがバッチ内の他の候補に依存しない                       │
│   ├─ キャッシャビリティ: 同一 (user, candidate) ペアは常に同じスコア                   │
│   └─ 並列推論: バッチサイズを任意に変更可能                                            │
│                                                                                         │
│   Implementation (grok.py):                                                             │
│   ```python                                                                             │
│   def make_recsys_attn_mask(seq_len, candidate_start_offset, dtype):                   │
│       causal_mask = jnp.tril(jnp.ones((1, 1, seq_len, seq_len), dtype=dtype))          │
│       attn_mask = causal_mask.at[:, :, candidate_start_offset:,                        │
│                                  candidate_start_offset:].set(0)                        │
│       candidate_indices = jnp.arange(candidate_start_offset, seq_len)                  │
│       attn_mask = attn_mask.at[:, :, candidate_indices, candidate_indices].set(1)      │
│       return attn_mask                                                                 │
│   ```                                                                                   │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. 運用考慮事項

### 8.1 スケーラビリティ

| コンポーネント | スケーリング戦略 |
|--------------|----------------|
| **Home Mixer** | 水平スケーリング（ステートレス） |
| **Thunder** | シャーディング（ユーザーID範囲） |
| **Phoenix Prediction** | GPU クラスタ、バッチ処理 |
| **Phoenix Retrieval** | ANN インデックス + レプリカ |

### 8.2 レイテンシバジェット

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              LATENCY BUDGET (P99 Target)                                 │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   Total Request: < 200ms                                                                │
│                                                                                         │
│   ├── Query Hydration:        ~20ms   (parallel)                                       │
│   ├── Candidate Sources:      ~30ms   (parallel)                                       │
│   │   ├── Thunder:            ~5ms    (in-memory)                                      │
│   │   └── Phoenix Retrieval:  ~25ms   (ANN search)                                     │
│   ├── Hydration:              ~30ms   (parallel, batched)                              │
│   ├── Pre-Scoring Filters:    ~10ms   (sequential)                                     │
│   ├── Phoenix Scoring:        ~80ms   (GPU inference)                                  │
│   ├── Weighted/Diversity:     ~5ms    (CPU)                                            │
│   ├── Selection:              ~2ms    (sort)                                           │
│   ├── Post-Selection:         ~20ms   (VF call)                                        │
│   └── Response Serialization: ~3ms                                                     │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 8.3 エラーハンドリング戦略

| ステージ | 失敗時の動作 |
|---------|------------|
| Query Hydration | エラーログ記録、デフォルト値で続行 |
| Thunder Source | スキップ、Phoenix のみで続行 |
| Phoenix Source | スキップ、Thunder のみで続行 |
| Hydration | 部分データで続行 |
| Phoenix Scoring | キャッシュスコア使用、または 0 スコア |
| VF Filter | 全候補通過（フェイルオープン） |

### 8.4 モニタリングメトリクス

```yaml
# 主要メトリクス
- request_latency_ms (histogram)
- candidates_retrieved (histogram)
- candidates_filtered (histogram)
- phoenix_prediction_latency_ms (histogram)
- thunder_lookup_latency_ms (histogram)
- cache_hit_rate (gauge)
- error_rate_by_component (counter)

# Thunder 固有
- post_store_total_posts (gauge)
- post_store_user_count (gauge)
- kafka_lag (gauge)
- trim_rate (counter)

# Phoenix 固有
- inference_batch_size (histogram)
- model_latency_ms (histogram)
- retrieval_recall@k (gauge)
```

---

## 付録

### A. 設定パラメータ

| パラメータ | デフォルト値 | 説明 |
|-----------|------------|------|
| `MAX_POST_AGE` | 172800s (2日) | 投稿の最大経過時間 |
| `RESULT_SIZE` | 50 | 返却する投稿数 |
| `MAX_POSTS_TO_RETURN` | 1500 | Thunder から取得する最大投稿数 |
| `MAX_INPUT_LIST_SIZE` | 5000 | フォローリストの最大サイズ |
| `RETENTION_SECONDS` | 172800s | Thunder の投稿保持期間 |

### B. 重み付けスコアリング係数

| アクション | 重み | 方向 |
|-----------|------|------|
| Favorite | 正 | ポジティブ |
| Reply | 正 | ポジティブ |
| Retweet | 正 | ポジティブ |
| Click | 正 | ポジティブ |
| Share | 正 | ポジティブ |
| Follow Author | 正 | ポジティブ |
| Not Interested | 負 | ネガティブ |
| Block Author | 負 | ネガティブ |
| Mute Author | 負 | ネガティブ |
| Report | 負 | ネガティブ |

---

**文書履歴**

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.0 | 2026-01-21 | 初版作成 |
